<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ChartVault ‚Äì Billboard Hot 100 & Billboard 200 Archive</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,500;0,9..40,700;0,9..40,800;1,9..40,400&family=DM+Mono:wght@400;500&family=Playfair+Display:ital,wght@0,700;0,900;1,700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
:root{--gold:#d4af37;--gold-dim:#d4af3744;--bg:#0a0a0a;--bg2:#111;--bg3:#141414;--border:#1a1a1a;--border2:#2a2a2a;--text:#e0e0e0;--text-dim:#888;--text-faint:#555;--text-ghost:#333;--up:#4ade80;--down:#f87171;--same:#666;--new:#fbbf24}
*{box-sizing:border-box;margin:0;padding:0}
body{min-height:100vh;background:linear-gradient(160deg,var(--bg),var(--bg2) 40%,#0d0d0d);color:var(--text);font-family:'DM Sans','Helvetica Neue',sans-serif;-webkit-font-smoothing:antialiased}
::selection{background:var(--gold-dim);color:#fff}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:#333;border-radius:3px}
input:focus,select:focus{outline:none}
a{color:var(--gold);text-decoration:none}

.header{padding:28px 24px 20px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,rgba(212,175,55,.03),transparent)}
.header-inner{max-width:960px;margin:0 auto}
.logo-row{display:flex;align-items:baseline;gap:12px;flex-wrap:wrap}
.logo{font-family:'Playfair Display',serif;font-size:32px;font-weight:900;color:var(--gold);letter-spacing:-.5px}
.tagline{font-size:11px;color:var(--text-faint);font-family:'DM Mono',monospace;letter-spacing:2px;text-transform:uppercase}
.nav{display:flex;gap:4px;margin-top:20px;flex-wrap:wrap}
.nav-btn{padding:8px 18px;border-radius:8px;border:none;background:rgba(255,255,255,.04);color:var(--text-dim);font-weight:500;font-size:13px;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .2s}
.nav-btn.active{background:var(--gold);color:#111;font-weight:700}
.nav-btn:hover:not(.active){background:rgba(255,255,255,.08)}

.main{max-width:960px;margin:0 auto;padding:24px}
.view{display:none}.view.active{display:block}

.load-msg{font-size:12px;color:var(--text-faint);font-family:'DM Mono',monospace;margin-bottom:12px;display:none}
.load-msg.visible{display:block}
.load-bar-wrap{background:#1a1a1a;border-radius:8px;height:6px;margin-bottom:20px;overflow:hidden;display:none}
.load-bar-wrap.visible{display:block}
.load-bar{height:100%;background:var(--gold);border-radius:8px;transition:width .3s;width:0%}

.selectors{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:20px}
.sel-group{flex:1 1 200px}
.sel-label{font-size:11px;color:var(--text-faint);text-transform:uppercase;letter-spacing:1px;display:block;margin-bottom:6px}
.sel-input,.sel-select{width:100%;padding:10px 14px;border-radius:8px;border:1px solid var(--border2);background:var(--bg3);color:var(--text);font-size:14px;font-family:'DM Sans',sans-serif}
select{cursor:pointer}

.jump-btns{display:flex;gap:5px;margin-bottom:20px;flex-wrap:wrap;align-items:center}
.jump-label{font-size:12px;color:var(--text-faint);margin-right:4px}
.jump-btn{padding:5px 12px;border-radius:6px;border:1px solid var(--border2);background:var(--bg3);color:var(--text-dim);font-size:11px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .15s}
.jump-btn:hover{border-color:var(--gold);color:var(--gold)}
.jump-btn.active{background:var(--gold);color:#111;border-color:var(--gold)}

.arrow-btn{padding:10px 14px;border:1px solid var(--border2);background:var(--bg3);color:var(--text-dim);font-size:16px;cursor:pointer;transition:all .15s}
.arrow-btn:hover{color:var(--gold);border-color:var(--gold)}
.arrow-btn:first-child{border-radius:8px 0 0 8px}
.arrow-btn:last-child{border-radius:0 8px 8px 0;border-left:none}

.chart-header{background:linear-gradient(135deg,rgba(212,175,55,.08),rgba(212,175,55,.02));border:1px solid #222;border-radius:14px;padding:20px 24px;margin-bottom:16px}
.chart-title{font-family:'Playfair Display',serif;font-size:24px;font-weight:700;color:#fff}
.chart-date{font-size:14px;color:var(--text-dim);margin-top:4px}
.chart-count{font-size:13px;color:var(--text-faint);margin-top:8px;font-family:'DM Mono',monospace}
.chart-legend{display:flex;gap:20px;margin-top:12px;font-size:11px;color:var(--text-faint);flex-wrap:wrap}

.show-more-wrap{text-align:center;padding:16px}
.show-more-btn{padding:10px 32px;border-radius:8px;border:1px solid var(--border2);background:var(--bg3);color:var(--gold);font-size:13px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .15s}
.show-more-btn:hover{background:var(--gold);color:#111}

.chart-list{background:var(--bg2);border:1px solid var(--border);border-radius:14px;overflow:hidden}
.chart-entry{display:flex;align-items:center;gap:14px;padding:10px 16px;transition:background .15s;cursor:default;opacity:0;transform:translateY(6px);animation:fadeIn .3s forwards}
.chart-entry:hover{background:rgba(255,255,255,.04)}
.chart-divider{height:1px;background:var(--border);margin:0 16px}
@keyframes fadeIn{to{opacity:1;transform:translateY(0)}}

.rank-badge{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;font-family:'DM Mono',monospace;flex-shrink:0}
.rank-badge.gold{background:var(--gold);color:#111;width:42px;height:42px;font-weight:800;font-size:15px;box-shadow:0 2px 12px #d4af3744}
.rank-badge.silver{background:#c0c0c0;color:#111;font-weight:800}
.rank-badge.bronze{background:#cd7f32;color:#111;font-weight:800}
.rank-badge.top10{background:rgba(255,255,255,.08);color:#ccc}
.rank-badge.normal{background:rgba(255,255,255,.04);color:#888;font-weight:500;font-size:12px}

.entry-info{flex:1;min-width:0}
.entry-title{font-weight:700;font-size:15px;color:#fff;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.entry-title.clickable:hover{text-decoration:underline;text-decoration-color:var(--gold);cursor:pointer}
.entry-meta{display:flex;align-items:center;gap:8px;margin-top:2px;flex-wrap:wrap}
.entry-artist{font-size:13px;color:var(--gold);cursor:pointer;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.entry-artist:hover{text-decoration:underline}
.entry-stats{display:flex;align-items:center;gap:12px;flex-shrink:0;font-size:12px}
.stat-col{text-align:center;min-width:28px}
.stat-header{color:var(--text-faint);font-size:10px;text-transform:uppercase;letter-spacing:.5px}
.stat-val{color:#999}
.movement{font-size:14px;width:20px;text-align:center}
.chart-badge{font-size:10px;color:#666;background:rgba(255,255,255,.04);padding:3px 8px;border-radius:10px;white-space:nowrap}

.search-wrap{position:relative;margin-bottom:20px}
.search-input{width:100%;padding:14px 20px;border-radius:12px;border:1px solid var(--border2);background:var(--bg3);color:var(--text);font-size:16px;font-family:'DM Sans',sans-serif}
.search-filters{display:flex;gap:4px;margin-top:8px}
.filter-btn{padding:5px 10px;border-radius:6px;border:none;background:rgba(255,255,255,.06);color:var(--text-dim);font-size:11px;font-weight:600;cursor:pointer;text-transform:uppercase;letter-spacing:.5px;font-family:'DM Sans',sans-serif;transition:all .15s}
.filter-btn.active{background:var(--gold);color:#111}
.result-count{font-size:13px;color:var(--text-faint);margin-bottom:16px;font-family:'DM Mono',monospace}

.artist-header{background:linear-gradient(135deg,rgba(212,175,55,.12),rgba(212,175,55,.02));border:1px solid #222;border-radius:16px;padding:28px;margin-bottom:20px;position:relative;overflow:hidden}
.artist-header::before{content:'';position:absolute;top:-40px;right:-40px;width:200px;height:200px;background:radial-gradient(circle,rgba(212,175,55,.08),transparent 70%);pointer-events:none}
.artist-name{font-family:'Playfair Display',serif;font-size:32px;font-weight:900;color:var(--gold);letter-spacing:-.5px}
.artist-years{font-size:13px;color:var(--text-dim);margin-top:4px;font-family:'DM Mono',monospace}

.stat-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:12px;margin-top:20px}
.stat-card{background:rgba(255,255,255,.03);border:1px solid #222;border-radius:12px;padding:16px;text-align:center;transition:all .2s}
.stat-card:hover{border-color:var(--gold-dim);background:rgba(212,175,55,.04)}
.stat-card-icon{font-size:24px;margin-bottom:6px}
.stat-card-val{font-size:28px;font-weight:800;color:#fff;font-family:'DM Mono',monospace}
.stat-card-val.gold-text{color:var(--gold)}
.stat-card-label{font-size:10px;color:var(--text-faint);text-transform:uppercase;letter-spacing:1px;margin-top:2px}

.timeline-section{margin-bottom:20px;padding:16px 20px;background:var(--bg2);border:1px solid var(--border);border-radius:12px}
.timeline-title{font-size:12px;color:var(--text-faint);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}
.timeline-bar{position:relative;height:32px;background:rgba(255,255,255,.03);border-radius:8px;overflow:hidden}
.timeline-active{position:absolute;height:100%;background:linear-gradient(90deg,var(--gold),#e8c547);border-radius:8px;min-width:4px}
.timeline-labels{display:flex;justify-content:space-between;margin-top:6px;font-size:10px;color:var(--text-faint);font-family:'DM Mono',monospace}
.timeline-dots{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}
.timeline-dot{position:absolute;top:50%;width:8px;height:8px;background:#fff;border-radius:50%;transform:translate(-50%,-50%);box-shadow:0 0 6px rgba(212,175,55,.5)}
.timeline-dot.no1{background:var(--gold);width:12px;height:12px;box-shadow:0 0 10px rgba(212,175,55,.8)}

.peak-chart{margin-bottom:20px;padding:20px;background:var(--bg2);border:1px solid var(--border);border-radius:12px}
.peak-chart-title{font-size:12px;color:var(--text-faint);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}
.peak-chart svg{width:100%;overflow:visible}
.chart-tooltip{position:absolute;pointer-events:none;background:#1a1a1a;border:1px solid var(--gold-dim);border-radius:6px;padding:6px 10px;font-size:11px;font-family:'DM Mono',monospace;color:#ccc;white-space:nowrap;z-index:100;opacity:0;transition:opacity .15s;box-shadow:0 4px 12px rgba(0,0,0,.5);max-width:260px}
.chart-tooltip.visible{opacity:1}
.chart-tooltip .tt-rank{color:var(--gold);font-weight:700;font-size:13px}
.chart-tooltip .tt-date{color:#888;font-size:10px}
.peak-chart{position:relative}

.decade-group{margin-bottom:24px}
.decade-header{display:flex;align-items:center;gap:12px;margin-bottom:12px;padding:0 4px}
.decade-label{font-family:'Playfair Display',serif;font-size:22px;font-weight:700;color:var(--gold)}
.decade-line{flex:1;height:1px;background:linear-gradient(90deg,var(--gold-dim),transparent)}
.decade-count{font-size:11px;color:var(--text-faint);font-family:'DM Mono',monospace}

.artist-stats-row{display:flex;gap:24px;margin-top:16px;flex-wrap:wrap}
.artist-stat-val{font-size:24px;font-weight:800;color:var(--gold);font-family:'DM Mono',monospace}
.artist-stat-label{font-size:11px;color:var(--text-faint);text-transform:uppercase;letter-spacing:.5px}
.no1-tag{font-size:10px;color:var(--gold);font-weight:700;letter-spacing:1px}
.sort-label{font-size:12px;color:var(--text-faint);margin-bottom:10px;font-family:'DM Mono',monospace}

.empty{text-align:center;padding:60px 24px;color:var(--text-faint);background:var(--bg2);border-radius:14px;border:1px solid var(--border)}
.empty-icon{font-size:48px;margin-bottom:12px}
.empty p{font-size:15px;color:#666}
.empty .sub{font-size:13px;margin-top:6px;color:#444}

.info-box{padding:16px 20px;background:rgba(212,175,55,.04);border:1px solid #222;border-radius:12px;margin-bottom:20px}
.info-box h3{font-size:14px;color:var(--gold);margin-bottom:4px}
.info-box p{font-size:13px;color:var(--text-dim);line-height:1.6}

.preload-section{margin-bottom:20px;padding:16px 20px;background:var(--bg2);border:1px solid var(--border);border-radius:12px}
.preload-section h3{font-size:14px;color:#fff;margin-bottom:8px}
.preload-section p{font-size:12px;color:var(--text-faint);margin-bottom:12px}
.preload-btns{display:flex;gap:8px;flex-wrap:wrap}
.preload-btn{padding:8px 16px;border-radius:8px;border:1px solid var(--border2);background:var(--bg3);color:var(--text);font-size:13px;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .15s}
.preload-btn:hover{border-color:var(--gold);color:var(--gold)}
.preload-btn:disabled{opacity:.4;cursor:default}
.preload-btn.done{border-color:#333;color:#4ade80;opacity:.7}

.cache-info{margin-top:10px;font-size:11px;color:var(--text-faint);font-family:'DM Mono',monospace}
.clear-btn{padding:4px 10px;border-radius:4px;border:1px solid #333;background:transparent;color:#666;font-size:11px;cursor:pointer;font-family:'DM Sans',sans-serif;margin-left:8px}
.clear-btn:hover{border-color:var(--down);color:var(--down)}

.narrative{padding:16px 20px;background:rgba(212,175,55,.04);border:1px solid #1f1f1f;border-radius:12px;margin-bottom:20px;line-height:1.7}
.narrative p{font-size:14px;color:var(--text-dim);margin:0}
.narrative strong{color:#ccc}
.narrative .gld{color:var(--gold);font-weight:700}

.artist-hero{display:flex;gap:24px;align-items:flex-start}
.artist-photo-wrap{flex-shrink:0;width:140px;height:140px;border-radius:14px;overflow:hidden;background:rgba(255,255,255,.03);border:1px solid #222;display:none}
.artist-photo-wrap.loaded{display:block}
.artist-photo-wrap img{width:100%;height:100%;object-fit:cover}
.artist-info-side{flex:1;min-width:0}

.song-hero{display:flex;gap:20px;align-items:flex-start}
.song-art-wrap{flex-shrink:0;width:120px;height:120px;border-radius:10px;overflow:hidden;background:rgba(255,255,255,.03);border:1px solid #222;display:none;box-shadow:0 4px 20px rgba(0,0,0,.4)}
.song-art-wrap.loaded{display:block}
.song-art-wrap img{width:100%;height:100%;object-fit:cover}
.song-info-side{flex:1;min-width:0}

.credits-section{padding:16px 20px;background:var(--bg2);border:1px solid var(--border);border-radius:12px;margin-bottom:20px}
.credits-section.loading{opacity:.6}
.credits-title{font-size:12px;color:var(--text-faint);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px}
.credits-row{display:flex;gap:8px;margin-bottom:8px;align-items:baseline;flex-wrap:wrap}
.credits-label{font-size:11px;color:var(--text-faint);text-transform:uppercase;letter-spacing:.5px;min-width:80px;flex-shrink:0}
.credits-names{font-size:14px;color:var(--text);line-height:1.5}
.credits-names span{color:var(--gold)}
.tracklist-section{padding:20px;background:var(--bg2);border:1px solid var(--border);border-radius:12px;margin-bottom:20px}
.tracklist-section.loading{opacity:.6}
.tracklist-title{font-size:12px;color:var(--text-faint);text-transform:uppercase;letter-spacing:1px;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.tracklist-title .track-count{font-size:11px;color:#555;font-weight:400}
.track-item{display:flex;align-items:center;gap:12px;padding:8px 4px;border-bottom:1px solid rgba(255,255,255,.03)}
.track-item:last-child{border-bottom:none}
.track-num{font-size:12px;color:#555;font-family:'DM Mono',monospace;width:22px;text-align:right;flex-shrink:0}
.track-name{font-size:14px;color:var(--text);flex:1}
.track-duration{font-size:12px;color:#555;font-family:'DM Mono',monospace;flex-shrink:0}
.track-disc-label{font-size:11px;color:var(--gold);text-transform:uppercase;letter-spacing:1px;padding:10px 0 4px;margin-top:4px;border-top:1px solid rgba(212,175,55,.15)}
.album-meta-row{display:flex;flex-wrap:wrap;gap:16px;margin-bottom:14px;font-size:13px;color:var(--text-dim)}
.album-meta-row span{color:var(--text-faint);font-size:11px;text-transform:uppercase;letter-spacing:.3px;margin-right:4px}

@media(max-width:600px){
  .artist-hero{flex-direction:column;align-items:center;text-align:center}
  .artist-photo-wrap{width:110px;height:110px}
  .song-hero{flex-direction:column;align-items:center;text-align:center}
  .song-art-wrap{width:100px;height:100px}
  .stat-cards{justify-items:center}
  .song-stats-row{justify-content:center}
}

.song-header{background:linear-gradient(135deg,rgba(212,175,55,.1),rgba(212,175,55,.02));border:1px solid #222;border-radius:14px;padding:24px;margin-bottom:16px}
.song-title-big{font-family:'Playfair Display',serif;font-size:26px;font-weight:900;color:#fff}
.song-artist-big{font-size:16px;color:var(--gold);margin-top:4px;cursor:pointer}
.song-artist-big:hover{text-decoration:underline}
.song-stats-row{display:flex;gap:24px;margin-top:16px;flex-wrap:wrap}
.back-btn{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;border-radius:6px;border:1px solid var(--border2);background:var(--bg3);color:var(--text-dim);font-size:12px;cursor:pointer;font-family:'DM Sans',sans-serif;margin-bottom:16px;transition:all .15s}
.back-btn:hover{border-color:var(--gold);color:var(--gold)}
.week-row{display:flex;align-items:center;gap:14px;padding:10px 16px;opacity:0;transform:translateY(6px);animation:fadeIn .3s forwards}
.week-row:hover{background:rgba(255,255,255,.04)}
.week-date{font-size:13px;color:var(--text-dim);min-width:140px;cursor:pointer;font-family:'DM Mono',monospace}
.week-date:hover{color:var(--gold);text-decoration:underline}

.chart-type-toggle{display:flex;gap:3px;margin-bottom:16px;background:rgba(255,255,255,.03);border-radius:10px;padding:3px;border:1px solid var(--border)}
.chart-type-btn{flex:1;padding:9px 16px;border-radius:8px;border:none;background:transparent;color:var(--text-dim);font-weight:600;font-size:13px;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .2s;text-align:center;white-space:nowrap}
.chart-type-btn.active{background:var(--gold);color:#111}
.chart-type-btn:hover:not(.active){background:rgba(255,255,255,.06)}
.b200-load-overlay{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:32px 24px;text-align:center;margin:24px 0}
.b200-load-overlay h3{font-family:'Playfair Display',serif;color:var(--gold);font-size:22px;margin-bottom:8px}
.b200-load-overlay p{color:var(--text-dim);font-size:13px;margin-bottom:16px;line-height:1.5}
.b200-load-btn{padding:12px 32px;border-radius:10px;border:none;background:var(--gold);color:#111;font-weight:700;font-size:14px;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .2s}
.b200-load-btn:hover{filter:brightness(1.1);transform:translateY(-1px)}
.b200-load-btn:disabled{opacity:.5;cursor:default;transform:none}
.b200-progress{margin-top:16px;display:none}
.b200-progress.visible{display:block}
.b200-progress-bar{background:#1a1a1a;border-radius:8px;height:8px;overflow:hidden;margin-top:8px}
.b200-progress-fill{height:100%;background:linear-gradient(90deg,var(--gold),#f0d060);border-radius:8px;transition:width .3s;width:0%}
.b200-progress-text{font-size:12px;color:var(--text-faint);font-family:'DM Mono',monospace;margin-top:6px}

.footer{margin-top:48px;padding-top:24px;border-top:1px solid var(--border);text-align:center}
.footer p{font-size:11px;color:var(--text-ghost);font-family:'DM Mono',monospace}
.footer .legal{font-size:10px;color:#262626;margin-top:4px}

@media(max-width:600px){
  .logo{font-size:26px}.tagline{display:none}
  .search-input{font-size:14px}
  .entry-stats{gap:8px}.stat-col:nth-child(n+3){display:none}
  .jump-btn{padding:4px 8px;font-size:10px}
}
</style>
</head>
<body>

<header class="header">
  <div class="header-inner">
    <div class="logo-row">
      <h1 class="logo">ChartVault</h1>
      <span class="tagline">Billboard Chart Archive</span>
    </div>
    <div class="chart-type-toggle">
      <button class="chart-type-btn active" onclick="switchChartType('hot100')">üéµ Hot 100 Singles</button>
      <button class="chart-type-btn" onclick="switchChartType('billboard200')">üíø Billboard 200 Albums</button>
    </div>
    <nav class="nav">
      <button class="nav-btn active" data-view="weekly" onclick="switchView('weekly')">üìä Weekly Charts</button>
      <button class="nav-btn" data-view="search" onclick="switchView('search')">üîç Search</button>
      <button class="nav-btn" data-view="artist" onclick="switchView('artist')">üé§ Artist Lookup</button>
    </nav>
  </div>
</header>

<div class="main">
  <div id="loadMsg" class="load-msg"></div>
  <div id="loadBarWrap" class="load-bar-wrap"><div id="loadBar" class="load-bar"></div></div>

  <!-- ‚ïê‚ïê‚ïê WEEKLY ‚ïê‚ïê‚ïê -->
  <div id="view-weekly" class="view active">
    <div id="startupInfo" class="info-box">
      <h3>‚è≥ Connecting to chart database...</h3>
      <p>ChartVault pulls real Billboard Hot 100 data from a free public database. Just a moment...</p>
    </div>

    <div id="b200StartupInfo" class="info-box" style="display:none"></div>

    <div id="weeklyControls" style="display:none">
      <div class="preload-section">
        <h3>üì• Load Full Decades</h3>
        <p>Load all chart weeks for a decade. This enables searching and artist lookup across the full period. Each decade takes 2‚Äì4 minutes on first load, then loads instantly on future visits (saved in your browser).</p>
        <div class="preload-btns">
          <button class="preload-btn" id="preload60s" onclick="preloadDecade(1958,1969)">60s (1958‚Äì69)</button>
          <button class="preload-btn" id="preload70s" onclick="preloadDecade(1970,1979)">70s</button>
          <button class="preload-btn" id="preload80s" onclick="preloadDecade(1980,1989)">80s</button>
          <button class="preload-btn" id="preload90s" onclick="preloadDecade(1990,1999)">90s</button>
          <button class="preload-btn" id="preload00s" onclick="preloadDecade(2000,2009)">00s</button>
          <button class="preload-btn" id="preload10s" onclick="preloadDecade(2010,2019)">10s</button>
          <button class="preload-btn" id="preloadAll" onclick="preloadDecade(1958,2019)">Load All (1958‚Äì2019)</button>
        </div>
        <div id="preloadStatus" style="font-size:12px;color:var(--text-faint);font-family:'DM Mono',monospace;margin-top:8px"></div>
        <div id="cacheInfo" class="cache-info"></div>
      </div>

      <div class="jump-btns">
        <span class="jump-label">Jump to:</span>
        <button class="jump-btn" onclick="jumpToYear(1958)">1958</button>
        <button class="jump-btn" onclick="jumpToYear(1962)">1962</button>
        <button class="jump-btn" onclick="jumpToYear(1965)">1965</button>
        <button class="jump-btn" onclick="jumpToYear(1968)">1968</button>
        <button class="jump-btn" onclick="jumpToYear(1970)">1970</button>
        <button class="jump-btn" onclick="jumpToYear(1973)">1973</button>
        <button class="jump-btn" onclick="jumpToYear(1976)">1976</button>
        <button class="jump-btn" onclick="jumpToYear(1979)">1979</button>
        <button class="jump-btn" onclick="jumpToYear(1982)">1982</button>
        <button class="jump-btn" onclick="jumpToYear(1985)">1985</button>
        <button class="jump-btn" onclick="jumpToYear(1988)">1988</button>
        <button class="jump-btn" onclick="jumpToYear(1991)">1991</button>
        <button class="jump-btn" onclick="jumpToYear(1994)">1994</button>
        <button class="jump-btn" onclick="jumpToYear(1997)">1997</button>
        <button class="jump-btn" onclick="jumpToYear(1999)">1999</button>
        <button class="jump-btn" onclick="jumpToYear(2002)">2002</button>
        <button class="jump-btn" onclick="jumpToYear(2005)">2005</button>
        <button class="jump-btn" onclick="jumpToYear(2008)">2008</button>
        <button class="jump-btn" onclick="jumpToYear(2010)">2010</button>
        <button class="jump-btn" onclick="jumpToYear(2013)">2013</button>
        <button class="jump-btn" onclick="jumpToYear(2016)">2016</button>
        <button class="jump-btn" onclick="jumpToYear(2019)">2019</button>
      </div>

      <div class="selectors">
        <div class="sel-group" style="flex:2">
          <label class="sel-label">Chart Week</label>
          <select id="dateSelect" class="sel-select" onchange="loadChartWeek()"></select>
        </div>
        <div class="sel-group" style="flex:0 0 auto;display:flex;align-items:flex-end">
          <button class="arrow-btn" onclick="prevWeek()">‚óÄ</button>
          <button class="arrow-btn" onclick="nextWeek()">‚ñ∂</button>
        </div>
      </div>
    </div>

    <!-- Billboard 200 controls -->
    <div id="b200Controls" style="display:none">
      <div class="jump-btns">
        <span class="jump-label">Jump to:</span>
        <button class="jump-btn" onclick="jumpToAlbumYear(1963)">1963</button>
        <button class="jump-btn" onclick="jumpToAlbumYear(1967)">1967</button>
        <button class="jump-btn" onclick="jumpToAlbumYear(1970)">1970</button>
        <button class="jump-btn" onclick="jumpToAlbumYear(1973)">1973</button>
        <button class="jump-btn" onclick="jumpToAlbumYear(1976)">1976</button>
        <button class="jump-btn" onclick="jumpToAlbumYear(1979)">1979</button>
        <button class="jump-btn" onclick="jumpToAlbumYear(1982)">1982</button>
        <button class="jump-btn" onclick="jumpToAlbumYear(1985)">1985</button>
        <button class="jump-btn" onclick="jumpToAlbumYear(1988)">1988</button>
        <button class="jump-btn" onclick="jumpToAlbumYear(1991)">1991</button>
        <button class="jump-btn" onclick="jumpToAlbumYear(1994)">1994</button>
        <button class="jump-btn" onclick="jumpToAlbumYear(1997)">1997</button>
        <button class="jump-btn" onclick="jumpToAlbumYear(2000)">2000</button>
        <button class="jump-btn" onclick="jumpToAlbumYear(2003)">2003</button>
        <button class="jump-btn" onclick="jumpToAlbumYear(2006)">2006</button>
        <button class="jump-btn" onclick="jumpToAlbumYear(2009)">2009</button>
        <button class="jump-btn" onclick="jumpToAlbumYear(2012)">2012</button>
        <button class="jump-btn" onclick="jumpToAlbumYear(2015)">2015</button>
        <button class="jump-btn" onclick="jumpToAlbumYear(2018)">2018</button>
        <button class="jump-btn" onclick="jumpToAlbumYear(2021)">2021</button>
        <button class="jump-btn" onclick="jumpToAlbumYear(2024)">2024</button>
      </div>

      <div class="selectors">
        <div class="sel-group" style="flex:2">
          <label class="sel-label">Chart Week</label>
          <select id="albumDateSelect" class="sel-select" onchange="loadAlbumChartWeek()"></select>
        </div>
        <div class="sel-group" style="flex:0 0 auto;display:flex;align-items:flex-end">
          <button class="arrow-btn" onclick="prevAlbumWeek()">‚óÄ</button>
          <button class="arrow-btn" onclick="nextAlbumWeek()">‚ñ∂</button>
        </div>
      </div>
      <div id="b200CacheInfo" class="cache-info"></div>
    </div>

    <div id="chartHeader"></div>
    <div id="chartList"></div>
  </div>

  <!-- ‚ïê‚ïê‚ïê SEARCH ‚ïê‚ïê‚ïê -->
  <div id="view-search" class="view">
    <div class="search-wrap">
      <input type="text" id="searchInput" class="search-input" placeholder="Search songs or artists..." oninput="doSearch()">
      <div class="search-filters">
        <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">All</button>
        <button class="filter-btn" data-filter="song" onclick="setFilter('song')"><span id="filterSongLabel">Song</span></button>
        <button class="filter-btn" data-filter="artist" onclick="setFilter('artist')">Artist</button>
      </div>
    </div>
    <div id="searchNote" class="info-box">
      <h3>How search works</h3>
      <p id="searchNoteText">Search finds songs across all loaded chart weeks. Use "Load Full Decades" on the Charts tab first for the most complete results.</p>
    </div>
    <div id="searchResults"></div>
  </div>

  <!-- ‚ïê‚ïê‚ïê ARTIST ‚ïê‚ïê‚ïê -->
  <div id="view-artist" class="view">
    <div class="selectors">
      <div class="sel-group" style="flex:1">
        <label class="sel-label">Artist Name</label>
        <input type="text" id="artistInput" class="sel-input" placeholder="Type an artist name..." oninput="filterArtists()">
      </div>
    </div>
    <div id="artistSuggestions" style="margin-bottom:16px"></div>
    <div id="artistContent">
      <div class="info-box">
        <h3>Artist Lookup</h3>
        <p id="artistHelpText">Type an artist name to see their chart history. Load full decades from the Charts tab for the most complete results.</p>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê SONG DETAIL ‚ïê‚ïê‚ïê -->
  <div id="view-song" class="view">
    <div id="songContent"></div>
  </div>

  <footer class="footer">
    <p>CHARTVAULT &bull; Hot 100 data from <a href="https://github.com/mhollingshead/billboard-hot-100" target="_blank">mhollingshead/billboard-hot-100</a> &bull; Billboard 200 data from <a href="https://github.com/utdata/rwd-billboard-data" target="_blank">utdata/rwd-billboard-data</a></p>
    <p class="legal">Billboard¬Æ is a registered trademark of Billboard Media, LLC. Chart data for reference only.</p>
    <p class="legal" id="footerStats"></p>
  </footer>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHARTVAULT v4 ‚Äì Billboard Hot 100 & Billboard 200 Archive
// With IndexedDB caching for instant loads on return visits
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const GH = 'https://raw.githubusercontent.com/mhollingshead/billboard-hot-100/main';
const B200_CSV = 'https://raw.githubusercontent.com/utdata/rwd-billboard-data/main/data-out/billboard-200-current.csv';
const DB_NAME = 'ChartVaultDB';
const DB_VERSION = 2;
const STORE_HOT = 'charts';
const STORE_ALBUM = 'albums';

// Active chart type: 'hot100' or 'billboard200'
let chartType = 'hot100';

// Hot 100 state
let allDates = [], filteredDates = [], chartCache = {};

// Billboard 200 state
let albumDates = [], filteredAlbumDates = [], albumCache = {};
let b200Loaded = false, b200Loading = false;

let currentDate = '', showCount = 40, isPreloading = false;
let db = null;
let previousView = 'weekly';

// Helpers to get active data based on chart type
function activeCache() { return chartType === 'hot100' ? chartCache : albumCache; }
function activeDates() { return chartType === 'hot100' ? filteredDates : filteredAlbumDates; }
function chartLabel() { return chartType === 'hot100' ? 'Hot 100' : 'Billboard 200'; }
function itemLabel(plural) { return chartType === 'hot100' ? (plural ? 'songs' : 'song') : (plural ? 'albums' : 'album'); }
function chartSize() { return chartType === 'hot100' ? 100 : 200; }

// ‚îÄ‚îÄ‚îÄ INDEXEDDB (browser storage) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// This saves chart data so you don't have to re-download it every visit

function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = (e) => {
      const d = e.target.result;
      if (!d.objectStoreNames.contains(STORE_HOT)) d.createObjectStore(STORE_HOT);
      if (!d.objectStoreNames.contains(STORE_ALBUM)) d.createObjectStore(STORE_ALBUM);
    };
    req.onsuccess = (e) => { db = e.target.result; resolve(db); };
    req.onerror = () => resolve(null); // Fail gracefully
  });
}

function dbPut(date, entries, store) {
  if (!db) return;
  const storeName = store || STORE_HOT;
  try {
    const tx = db.transaction(storeName, 'readwrite');
    tx.objectStore(storeName).put(entries, date);
  } catch(e) { /* ignore storage errors */ }
}

function dbGet(date, store) {
  if (!db) return Promise.resolve(null);
  const storeName = store || STORE_HOT;
  return new Promise((resolve) => {
    try {
      const tx = db.transaction(storeName, 'readonly');
      const req = tx.objectStore(storeName).get(date);
      req.onsuccess = () => resolve(req.result || null);
      req.onerror = () => resolve(null);
    } catch(e) { resolve(null); }
  });
}

function dbGetAllKeys(store) {
  if (!db) return Promise.resolve([]);
  const storeName = store || STORE_HOT;
  return new Promise((resolve) => {
    try {
      const tx = db.transaction(storeName, 'readonly');
      const req = tx.objectStore(storeName).getAllKeys();
      req.onsuccess = () => resolve(req.result || []);
      req.onerror = () => resolve([]);
    } catch(e) { resolve([]); }
  });
}

function dbClear(store) {
  if (!db) return;
  const storeName = store || STORE_HOT;
  try {
    const tx = db.transaction(storeName, 'readwrite');
    tx.objectStore(storeName).clear();
  } catch(e) {}
}

// Load all saved data from IndexedDB into memory
async function loadFromDB(store, targetCache) {
  if (!db) return 0;
  const storeName = store || STORE_HOT;
  const cache = targetCache || chartCache;
  return new Promise((resolve) => {
    try {
      const tx = db.transaction(storeName, 'readonly');
      const s = tx.objectStore(storeName);
      const req = s.openCursor();
      let count = 0;
      req.onsuccess = (e) => {
        const cursor = e.target.result;
        if (cursor) {
          if (Array.isArray(cursor.value) && cursor.value.length > 0) {
            cache[cursor.key] = cursor.value;
            count++;
          }
          cursor.continue();
        } else {
          resolve(count);
        }
      };
      req.onerror = () => resolve(0);
    } catch(e) { resolve(0); }
  });
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function init() {
  await openDB();

  // Load Hot 100 cached data
  const cachedCount = await loadFromDB(STORE_HOT, chartCache);

  // Load Billboard 200 cached data
  const albumCachedCount = await loadFromDB(STORE_ALBUM, albumCache);
  if (albumCachedCount > 0) {
    albumDates = Object.keys(albumCache).sort();
    filteredAlbumDates = albumDates;
    b200Loaded = true;
  }

  try {
    const r = await fetch(GH + '/valid_dates.json');
    if (!r.ok) throw new Error('HTTP ' + r.status);
    allDates = await r.json();

    filteredDates = allDates.filter(d => {
      const y = +d.substring(0, 4);
      return y >= 1958 && y <= 2019;
    });

    let msg = `‚úÖ Ready ‚Äî ${filteredDates.length} chart weeks available (1958‚Äì2019)`;
    if (cachedCount > 0) {
      msg = `‚úÖ Ready ‚Äî ${filteredDates.length} weeks available &bull; ${cachedCount} already saved in your browser`;
    }
    document.getElementById('startupInfo').innerHTML = `<h3>${msg}</h3><p>Pick any week to view the full Hot 100. Use "Load Full Decades" for searching and artist lookup across entire decades.</p>`;

    populateDateSelect();
    document.getElementById('weeklyControls').style.display = 'block';
    updateCacheInfo();

    const def = filteredDates.find(d => d.startsWith('1979-08')) || filteredDates[Math.floor(filteredDates.length / 2)];
    document.getElementById('dateSelect').value = def;
    loadChartWeek();

  } catch(e) {
    if (cachedCount > 0) {
      filteredDates = Object.keys(chartCache).sort();
      document.getElementById('startupInfo').innerHTML = `<h3 style="color:var(--new)">üì¥ Offline Mode ‚Äî ${cachedCount} saved weeks available</h3><p>Could not reach GitHub, but your previously loaded data is available.</p>`;
      populateDateSelect();
      document.getElementById('weeklyControls').style.display = 'block';
      if (filteredDates.length) {
        document.getElementById('dateSelect').value = filteredDates[Math.floor(filteredDates.length / 2)];
        loadChartWeek();
      }
    } else {
      document.getElementById('startupInfo').innerHTML = `<h3 style="color:var(--down)">‚ö†Ô∏è Connection Error</h3><p>Could not reach the chart database. Make sure you're connected to the internet and refresh.</p><p style="margin-top:8px;font-size:12px;color:#555">${e.message}</p>`;
    }
  }
}

// ‚îÄ‚îÄ‚îÄ CHART TYPE SWITCHING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function switchChartType(type) {
  if (type === chartType) return;
  chartType = type;
  document.querySelectorAll('.chart-type-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');

  if (type === 'billboard200') {
    showBillboard200View();
  } else {
    showHot100View();
  }
}

function showHot100View() {
  document.getElementById('b200Controls').style.display = 'none';
  document.getElementById('weeklyControls').style.display = 'block';
  document.getElementById('startupInfo').style.display = 'block';
  document.getElementById('b200StartupInfo').style.display = 'none';
  // Update search/artist labels
  document.getElementById('searchInput').placeholder = 'Search songs or artists...';
  document.getElementById('filterSongLabel').textContent = 'Song';
  document.getElementById('searchNoteText').textContent = 'Search finds songs across all loaded chart weeks. Use "Load Full Decades" on the Charts tab first for the most complete results.';
  document.getElementById('artistHelpText').textContent = 'Type an artist name to see their chart history. Load full decades from the Charts tab for the most complete results.';
  switchView('weekly');
  if (currentDate && chartCache[currentDate]) {
    displayChart(currentDate, chartCache[currentDate]);
  }
  updateStats();
}

function showBillboard200View() {
  document.getElementById('weeklyControls').style.display = 'none';
  document.getElementById('startupInfo').style.display = 'none';
  document.getElementById('b200StartupInfo').style.display = 'block';
  // Update search/artist labels
  document.getElementById('searchInput').placeholder = 'Search albums or artists...';
  document.getElementById('filterSongLabel').textContent = 'Album';
  document.getElementById('searchNoteText').textContent = 'Search finds albums across all Billboard 200 chart weeks. Download Billboard 200 data from the Charts tab first.';
  document.getElementById('artistHelpText').textContent = 'Type an artist name to see their Billboard 200 album chart history.';
  switchView('weekly');

  if (b200Loaded && filteredAlbumDates.length > 0) {
    document.getElementById('b200Controls').style.display = 'block';
    document.getElementById('b200StartupInfo').innerHTML = `<h3>‚úÖ Billboard 200 ‚Äî ${filteredAlbumDates.length} chart weeks loaded</h3><p>Browse album charts, search albums, or look up artists.</p>`;
    populateAlbumDateSelect();
    updateAlbumCacheInfo();
    if (!currentDate || !albumCache[currentDate]) {
      const def = filteredAlbumDates.find(d => d.startsWith('1979')) || filteredAlbumDates[Math.floor(filteredAlbumDates.length / 2)];
      document.getElementById('albumDateSelect').value = def;
      loadAlbumChartWeek();
    }
  } else {
    document.getElementById('b200Controls').style.display = 'none';
    document.getElementById('b200StartupInfo').innerHTML = `
      <div class="b200-load-overlay">
        <h3>üíø Billboard 200 Album Charts</h3>
        <p>Load the complete Billboard 200 album chart history (1963‚Äìpresent).<br>
        This downloads ~35MB of data once, then saves to your browser for instant access on future visits.</p>
        <button class="b200-load-btn" id="b200LoadBtn" onclick="loadBillboard200()">Download Billboard 200 Data</button>
        <div class="b200-progress" id="b200Progress">
          <div class="b200-progress-bar"><div class="b200-progress-fill" id="b200ProgressFill"></div></div>
          <div class="b200-progress-text" id="b200ProgressText"></div>
        </div>
      </div>`;
  }
}

// ‚îÄ‚îÄ‚îÄ BILLBOARD 200 CSV LOADING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function loadBillboard200() {
  if (b200Loading) return;
  b200Loading = true;
  const btn = document.getElementById('b200LoadBtn');
  const prog = document.getElementById('b200Progress');
  const fill = document.getElementById('b200ProgressFill');
  const txt = document.getElementById('b200ProgressText');
  btn.disabled = true;
  btn.textContent = 'Downloading...';
  prog.classList.add('visible');
  txt.textContent = 'Downloading Billboard 200 data...';
  fill.style.width = '5%';

  try {
    if (typeof Papa === 'undefined') throw new Error('CSV parser not loaded. Please refresh and try again.');

    // Fetch the CSV text
    const response = await fetch(B200_CSV);
    if (!response.ok) throw new Error('HTTP ' + response.status);
    fill.style.width = '30%';
    txt.textContent = 'Reading response...';

    const csvText = await response.text();
    fill.style.width = '45%';
    txt.textContent = 'Parsing ' + (csvText.length / 1048576).toFixed(1) + ' MB of chart data...';

    // Parse with step mode to avoid double-memory from holding parsed array
    const tempCache = {};
    let rowCount = 0;
    let headerParsed = false;
    let dateIdx, rankIdx, titleIdx, artistIdx, lwIdx, peakIdx, wksIdx;

    Papa.parse(csvText, {
      header: false,
      skipEmptyLines: true,
      step: function(result) {
        const row = result.data;
        if (!row || row.length < 4) return;

        if (!headerParsed) {
          const h = row.map(function(c) { return (c || '').trim().toLowerCase(); });
          // Try known column names
          dateIdx = h.indexOf('chart_date');
          if (dateIdx < 0) dateIdx = h.indexOf('chart week');
          if (dateIdx < 0) dateIdx = h.indexOf('chart_week');
          rankIdx = h.indexOf('current_rank');
          if (rankIdx < 0) rankIdx = h.indexOf('this week');
          if (rankIdx < 0) rankIdx = h.indexOf('this_week');
          titleIdx = h.indexOf('title');
          if (titleIdx < 0) titleIdx = h.indexOf('song');
          artistIdx = h.indexOf('performer');
          if (artistIdx < 0) artistIdx = h.indexOf('artist');
          lwIdx = h.indexOf('previous_rank');
          if (lwIdx < 0) lwIdx = h.indexOf('last week');
          if (lwIdx < 0) lwIdx = h.indexOf('last_week');
          if (lwIdx < 0) lwIdx = h.indexOf('previous_week');
          peakIdx = h.indexOf('peak_rank');
          if (peakIdx < 0) peakIdx = h.indexOf('peak pos.');
          if (peakIdx < 0) peakIdx = h.indexOf('peak_pos');
          if (peakIdx < 0) peakIdx = h.indexOf('peak_position');
          wksIdx = h.indexOf('wks_on_chart');
          if (wksIdx < 0) wksIdx = h.indexOf('wks on chart');
          if (wksIdx < 0) wksIdx = h.indexOf('weeks_on_chart');
          if (wksIdx < 0) wksIdx = h.indexOf('time_on_chart');

          // If we matched at least date+rank+title, it's a header row
          if (dateIdx >= 0 && rankIdx >= 0 && titleIdx >= 0) {
            headerParsed = true;
            return;
          }
          // Otherwise assume positional and process this row as data
          dateIdx = 0; rankIdx = 1; titleIdx = 2; artistIdx = 3; lwIdx = 4; peakIdx = 5; wksIdx = 6;
          headerParsed = true;
          // Fall through to process this row as data
        }

        var rawDate = (row[dateIdx] || '').trim();
        if (!rawDate) return;

        // Normalize date
        var date;
        if (/^\d{4}-\d{2}-\d{2}$/.test(rawDate)) {
          date = rawDate;
        } else if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(rawDate)) {
          var parts = rawDate.split('/');
          date = parts[2] + '-' + parts[0].padStart(2,'0') + '-' + parts[1].padStart(2,'0');
        } else {
          try { var d = new Date(rawDate); if (!isNaN(d.getTime())) date = d.toISOString().substring(0,10); else return; } catch(ex) { return; }
        }

        var rank = parseInt(row[rankIdx]) || 0;
        var title = (row[titleIdx] || '').trim();
        var artist = artistIdx >= 0 ? (row[artistIdx] || '').trim() : '';
        if (!title || !rank) return;

        var lw = lwIdx >= 0 ? (parseInt(row[lwIdx]) || null) : null;
        var peak = peakIdx >= 0 ? (parseInt(row[peakIdx]) || rank) : rank;
        var wks = wksIdx >= 0 ? (parseInt(row[wksIdx]) || 1) : 1;

        if (!tempCache[date]) tempCache[date] = [];
        tempCache[date].push({ rank: rank, title: title, artist: artist, lastWeek: lw, peak: peak, weeks: wks });
        rowCount++;
      }
    });

    if (rowCount === 0) throw new Error('CSV parsed but no valid rows found. Headers detected: dateIdx=' + dateIdx + ' rankIdx=' + rankIdx + ' titleIdx=' + titleIdx);

    fill.style.width = '80%';
    txt.textContent = 'Sorting ' + rowCount.toLocaleString() + ' entries...';
    await new Promise(function(r) { setTimeout(r, 0); });

    // Sort each week by rank
    var dates = Object.keys(tempCache);
    for (var i = 0; i < dates.length; i++) {
      tempCache[dates[i]].sort(function(a, b) { return a.rank - b.rank; });
    }

    fill.style.width = '88%';
    txt.textContent = 'Saving to browser...';
    await new Promise(function(r) { setTimeout(r, 0); });

    albumCache = tempCache;
    albumDates = dates.sort();
    filteredAlbumDates = albumDates;

    // Save to IndexedDB in batches
    for (var j = 0; j < albumDates.length; j++) {
      dbPut(albumDates[j], albumCache[albumDates[j]], STORE_ALBUM);
      if (j % 100 === 0) {
        fill.style.width = (88 + Math.round((j / albumDates.length) * 12)) + '%';
        await new Promise(function(r) { setTimeout(r, 0); });
      }
    }

    b200Loaded = true;
    b200Loading = false;
    fill.style.width = '100%';
    txt.textContent = rowCount.toLocaleString() + ' entries across ' + albumDates.length + ' weeks loaded!';
    showBillboard200View();

  } catch(e) {
    b200Loading = false;
    btn.disabled = false;
    btn.textContent = 'Retry Download';
    txt.textContent = '‚ùå Error: ' + e.message + '. Please try again.';
    fill.style.width = '0%';
    console.error('BB200 load error:', e);
  }
}

function populateAlbumDateSelect() {
  const s = document.getElementById('albumDateSelect');
  if (!s) return;
  s.innerHTML = [...filteredAlbumDates].reverse().map(d => `<option value="${d}">${fmtDate(d)}</option>`).join('');
}

function updateAlbumCacheInfo() {
  const el = document.getElementById('b200CacheInfo');
  if (!el) return;
  const n = filteredAlbumDates.length;
  const totalEntries = Object.values(albumCache).reduce((s, e) => s + (Array.isArray(e) ? e.length : 0), 0);
  if (n > 0) {
    const range = filteredAlbumDates[0].substring(0,4) + '‚Äì' + filteredAlbumDates[n-1].substring(0,4);
    el.innerHTML = `üíæ ${n} weeks saved (${range}) &bull; ${totalEntries.toLocaleString()} entries <button class="clear-btn" onclick="clearAlbumCache()">Clear album data</button>`;
  }
}

function clearAlbumCache() {
  if (!confirm('This will delete all saved Billboard 200 data from your browser. You will need to re-download it. Continue?')) return;
  dbClear(STORE_ALBUM);
  albumCache = {};
  albumDates = [];
  filteredAlbumDates = [];
  b200Loaded = false;
  showBillboard200View();
}

function jumpToAlbumYear(y) {
  const d = filteredAlbumDates.find(d => d.startsWith(String(y)));
  if (d) { document.getElementById('albumDateSelect').value = d; loadAlbumChartWeek(); }
  document.querySelectorAll('#b200Controls .jump-btn').forEach(b => b.classList.remove('active'));
  if (event && event.target) event.target.classList.add('active');
}

function prevAlbumWeek() {
  const i = filteredAlbumDates.indexOf(currentDate);
  if (i > 0) { document.getElementById('albumDateSelect').value = filteredAlbumDates[i-1]; loadAlbumChartWeek(); }
}

function nextAlbumWeek() {
  const i = filteredAlbumDates.indexOf(currentDate);
  if (i < filteredAlbumDates.length-1) { document.getElementById('albumDateSelect').value = filteredAlbumDates[i+1]; loadAlbumChartWeek(); }
}

async function loadAlbumChartWeek() {
  const date = document.getElementById('albumDateSelect').value;
  if (!date) return;
  currentDate = date;
  showCount = 40;

  if (albumCache[date] && albumCache[date].length > 0) {
    displayChart(date, albumCache[date]);
    return;
  }

  document.getElementById('chartHeader').innerHTML = `<h2 class="chart-title">Billboard 200</h2><div class="chart-date">Week of ${fmtDate(date)}</div>`;
  document.getElementById('chartList').innerHTML = `<div class="empty"><div class="empty-icon">‚è≥</div><p>Loading chart...</p></div>`;
}

// ‚îÄ‚îÄ‚îÄ DATE NAV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function populateDateSelect() {
  const s = document.getElementById('dateSelect');
  s.innerHTML = [...filteredDates].reverse().map(d => `<option value="${d}">${fmtDate(d)}</option>`).join('');
}

function jumpToYear(y) {
  const d = filteredDates.find(d => d.startsWith(String(y)));
  if (d) { document.getElementById('dateSelect').value = d; loadChartWeek(); }
  document.querySelectorAll('.jump-btn').forEach(b => b.classList.remove('active'));
  if (event && event.target) event.target.classList.add('active');
}

function prevWeek() {
  const i = filteredDates.indexOf(currentDate);
  if (i > 0) { document.getElementById('dateSelect').value = filteredDates[i-1]; loadChartWeek(); }
}

function nextWeek() {
  const i = filteredDates.indexOf(currentDate);
  if (i < filteredDates.length-1) { document.getElementById('dateSelect').value = filteredDates[i+1]; loadChartWeek(); }
}

// ‚îÄ‚îÄ‚îÄ FETCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

async function fetchWeek(date, retries) {
  if (retries === undefined) retries = 2;
  // Memory cache
  if (chartCache[date] && chartCache[date].length > 0) return chartCache[date];
  // Try IndexedDB
  const saved = await dbGet(date, STORE_HOT);
  if (saved && Array.isArray(saved) && saved.length > 0) {
    chartCache[date] = saved;
    return saved;
  }
  // Fetch from GitHub
  for (let attempt = 0; attempt <= retries; attempt++) {
    try {
      const r = await fetch(`${GH}/date/${date}.json`);
      if (!r.ok) { if (attempt < retries) { await sleep(600); continue; } throw new Error('HTTP ' + r.status); }
      const raw = await r.json();
      if (!raw || !raw.data || !Array.isArray(raw.data) || raw.data.length === 0) {
        if (attempt < retries) { await sleep(600); continue; }
        throw new Error('Empty data');
      }
      const entries = raw.data.map(e => ({
        rank: e.this_week,
        title: (e.song || '').trim(),
        artist: (e.artist || '').trim(),
        lastWeek: e.last_week,
        peak: e.peak_position,
        weeks: e.weeks_on_chart
      }));
      chartCache[date] = entries;
      dbPut(date, entries, STORE_HOT); // Save to browser
      return entries;
    } catch(e) {
      if (attempt >= retries) throw e;
      await sleep(600);
    }
  }
}

async function loadChartWeek() {
  const date = document.getElementById('dateSelect').value;
  if (!date) return;
  currentDate = date;
  showCount = 40;

  if (chartCache[date] && chartCache[date].length > 0) {
    displayChart(date, chartCache[date]);
    return;
  }

  document.getElementById('chartHeader').innerHTML = `<h2 class="chart-title">Hot 100</h2><div class="chart-date">Week of ${fmtDate(date)}</div>`;
  document.getElementById('chartList').innerHTML = `<div class="empty"><div class="empty-icon">‚è≥</div><p>Loading chart...</p></div>`;

  try {
    const entries = await fetchWeek(date);
    displayChart(date, entries);
    updateStats();
  } catch(e) {
    document.getElementById('chartList').innerHTML = `<div class="empty"><div class="empty-icon">‚ùå</div><p>Could not load ${fmtDate(date)}</p><p class="sub">${e.message}</p></div>`;
  }
}

function displayChart(date, entries) {
  const dates = activeDates();
  const wi = dates.indexOf(date);
  const wn = wi >= 0 ? wi + 1 : '?';
  const label = chartLabel();
  document.getElementById('chartHeader').innerHTML = `
    <h2 class="chart-title">Billboard ${label}</h2>
    <div class="chart-date">Week of ${fmtDate(date)}</div>
    <div class="chart-count">${entries.length} positions &bull; Week ${wn} of ${dates.length}</div>
    <div class="chart-legend"><span style="color:var(--up)">‚ñ≤ Up</span> <span style="color:var(--down)">‚ñº Down</span> <span style="color:var(--same)">‚ñ† Same</span> <span style="color:var(--new)">‚òÖ New</span></div>`;
  const vis = entries.slice(0, showCount);
  let h = '<div class="chart-list">';
  vis.forEach((e, i) => { h += renderEntry(e, i); if (i < vis.length - 1) h += '<div class="chart-divider"></div>'; });
  h += '</div>';
  if (showCount < entries.length) h += `<div class="show-more-wrap"><button class="show-more-btn" onclick="showMore()">Show All ${entries.length} Positions</button></div>`;
  document.getElementById('chartList').innerHTML = h;
}

function showMore() { showCount = chartSize(); displayChart(currentDate, activeCache()[currentDate]); }

// ‚îÄ‚îÄ‚îÄ PRELOAD DECADES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function preloadDecade(startYr, endYr) {
  if (isPreloading) return;
  isPreloading = true;
  const dates = filteredDates.filter(d => { const y = +d.substring(0,4); return y >= startYr && y <= endYr; });
  const toLoad = dates.filter(d => !chartCache[d] || chartCache[d].length === 0);

  if (toLoad.length === 0) {
    document.getElementById('preloadStatus').textContent = `‚úÖ All ${dates.length} weeks from ${startYr}‚Äì${endYr} already loaded!`;
    isPreloading = false;
    return;
  }

  document.querySelectorAll('.preload-btn').forEach(b => b.disabled = true);
  const status = document.getElementById('preloadStatus');
  const barWrap = document.getElementById('loadBarWrap');
  const bar = document.getElementById('loadBar');
  barWrap.classList.add('visible');

  let done = 0, success = 0, errors = 0;

  // 2 concurrent requests with delay between batches
  for (let i = 0; i < toLoad.length; i += 2) {
    const batch = toLoad.slice(i, i + 2);
    const results = await Promise.allSettled(batch.map(d => fetchWeek(d)));
    results.forEach(r => {
      if (r.status === 'fulfilled' && r.value && r.value.length > 0) success++;
      else errors++;
    });
    done += batch.length;
    const pct = Math.round(done / toLoad.length * 100);
    bar.style.width = pct + '%';
    status.textContent = `Loading ${startYr}‚Äì${endYr}: ${done}/${toLoad.length} (${success} ok${errors ? ', ' + errors + ' retry needed' : ''}) ${pct}%`;
    if (i + 2 < toLoad.length) await sleep(200);
  }

  barWrap.classList.remove('visible');
  const tw = validWeekCount();
  status.textContent = `‚úÖ Done! ${success} weeks loaded. Total: ${tw} weeks in memory.`;
  document.querySelectorAll('.preload-btn').forEach(b => b.disabled = false);
  isPreloading = false;
  updateStats();
  updateCacheInfo();
}

function clearCache() {
  const label = chartType === 'hot100' ? 'Hot 100' : 'Billboard 200';
  if (!confirm(`This will delete all saved ${label} data from your browser. You will need to re-download it. Continue?`)) return;
  if (chartType === 'hot100') {
    dbClear(STORE_HOT);
    chartCache = {};
  } else {
    dbClear(STORE_ALBUM);
    albumCache = {};
    albumDates = [];
    filteredAlbumDates = [];
    b200Loaded = false;
  }
  updateCacheInfo();
  updateStats();
  document.getElementById('preloadStatus').textContent = 'Cache cleared.';
}

function updateCacheInfo() {
  const n = validWeekCount();
  const el = document.getElementById('cacheInfo');
  if (n > 0) {
    el.innerHTML = `üíæ ${n} weeks saved in browser (loads instantly on future visits) <button class="clear-btn" onclick="clearCache()">Clear saved data</button>`;
  } else {
    el.innerHTML = 'üíæ No data saved yet. Load decades above ‚Äî they\'ll be saved for future visits.';
  }
}

// ‚îÄ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

let searchFilter = 'all';

function setFilter(f) {
  searchFilter = f;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.toggle('active', b.dataset.filter === f));
  doSearch();
}

function doSearch() {
  const q = document.getElementById('searchInput').value.toLowerCase().trim();
  const c = document.getElementById('searchResults');
  if (q.length < 2) { c.innerHTML = ''; return; }

  const cache = activeCache();
  const results = [], seen = new Map();
  for (const [date, entries] of Object.entries(cache)) {
    if (!Array.isArray(entries)) continue;
    try {
      for (const e of entries) {
        if (!e || !e.title || !e.artist) continue;
        const tm = e.title.toLowerCase().includes(q);
        const am = e.artist.toLowerCase().includes(q);
        const m = searchFilter === 'song' ? tm : searchFilter === 'artist' ? am : (tm || am);
        if (m) {
          const k = e.title + '|' + e.artist;
          if (!seen.has(k)) {
            const item = { ...e, date };
            seen.set(k, item);
            results.push(item);
          } else {
            const existing = seen.get(k);
            if (e.peak && (!existing.peak || e.peak < existing.peak)) existing.peak = e.peak;
            if (e.weeks && (!existing.weeks || e.weeks > existing.weeks)) existing.weeks = e.weeks;
          }
        }
      }
    } catch(err) {}
  }

  results.sort((a, b) => (a.peak || 999) - (b.peak || 999));
  const cw = validWeekCount();
  const il = itemLabel(results.length !== 1);
  let h = `<div class="result-count">${results.length} unique ${il} across ${cw} loaded weeks</div>`;
  if (!results.length) {
    h += `<div class="empty"><div class="empty-icon">üîá</div><p>No results for "${q}"</p><p class="sub">${chartType === 'hot100' ? 'Load more decades from the Charts tab for more results' : 'Make sure Billboard 200 data is loaded'}</p></div>`;
  } else {
    h += '<div class="chart-list">';
    results.slice(0, 100).forEach((e, i) => {
      h += renderEntry(e, i, true);
      if (i < Math.min(results.length, 100) - 1) h += '<div class="chart-divider"></div>';
    });
    h += '</div>';
    if (results.length > 100) h += `<div style="text-align:center;padding:12px;font-size:12px;color:var(--text-faint)">Showing top 100 of ${results.length} results</div>`;
  }
  c.innerHTML = h;
}

// ‚îÄ‚îÄ‚îÄ ARTIST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function filterArtists() {
  const q = document.getElementById('artistInput').value.toLowerCase().trim();
  const sb = document.getElementById('artistSuggestions');
  if (q.length < 2) { sb.innerHTML = ''; return; }

  const cache = activeCache();
  const artists = new Map();
  for (const entries of Object.values(cache)) {
    if (!Array.isArray(entries)) continue;
    try {
      for (const e of entries) {
        if (!e || !e.artist) continue;
        if (e.artist.toLowerCase().includes(q)) {
          if (!artists.has(e.artist)) artists.set(e.artist, { name: e.artist, count: 0, titles: new Set() });
          const a = artists.get(e.artist);
          if (!a.titles.has(e.title)) { a.titles.add(e.title); a.count++; }
        }
      }
    } catch(err) {}
  }

  const sorted = [...artists.values()].sort((a, b) => b.count - a.count).slice(0, 12);
  sb.innerHTML = sorted.map(a =>
    `<button onclick="showArtist('${esc(a.name)}')" style="padding:6px 14px;border-radius:6px;border:1px solid var(--border2);background:var(--bg3);color:var(--gold);font-size:13px;cursor:pointer;font-family:'DM Sans',sans-serif;margin:0 4px 4px 0">${a.name} <span style="color:#666">(${a.count})</span></button>`
  ).join('');

  if (sorted.length === 1 || (sorted.length > 0 && sorted[0].name.toLowerCase() === q)) showArtist(sorted[0].name);
}

function showArtist(name) {
  document.getElementById('artistInput').value = name;
  document.getElementById('artistSuggestions').innerHTML = '';

  const cache = activeCache();
  const isAlbum = chartType === 'billboard200';
  const hits = new Map();
  for (const [date, entries] of Object.entries(cache)) {
    if (!Array.isArray(entries)) continue;
    try {
      for (const e of entries) {
        if (!e || e.artist !== name) continue;
        if (!hits.has(e.title)) {
          hits.set(e.title, { title: e.title, peak: e.peak || e.rank, weeks: e.weeks || 1, firstDate: date });
        } else {
          const h = hits.get(e.title);
          if ((e.peak || e.rank) < h.peak) h.peak = e.peak || e.rank;
          if ((e.weeks || 0) > h.weeks) h.weeks = e.weeks;
          if (date < h.firstDate) h.firstDate = date;
        }
      }
    } catch(err) {}
  }

  const hl = [...hits.values()].sort((a, b) => (a.firstDate || '').localeCompare(b.firstDate || ''));
  const n1 = hl.filter(h => h.peak === 1).length;
  const t10 = hl.filter(h => h.peak <= 10).length;
  const t40 = hl.filter(h => h.peak <= 40).length;
  const bp = hl.length ? Math.min(...hl.map(h => h.peak)) : 0;
  const totalWks = hl.reduce((s, h) => s + (h.weeks || 0), 0);
  const c = document.getElementById('artistContent');

  if (!hl.length) {
    c.innerHTML = `<div class="empty"><div class="empty-icon">üé§</div><p>No chart data for "${name}"</p><p class="sub">${chartType === 'hot100' ? 'Load more decades for more results' : 'Make sure Billboard 200 data is loaded'}</p></div>`;
    return;
  }

  // Year range
  const years = hl.map(h => h.firstDate ? +h.firstDate.substring(0,4) : 0).filter(y => y > 0);
  const minY = Math.min(...years), maxY = Math.max(...years);
  const yearSpan = minY === maxY ? String(minY) : `${minY}‚Äì${maxY}`;

  // ‚îÄ‚îÄ‚îÄ HEADER with stat cards ‚îÄ‚îÄ‚îÄ
  let h = `<div class="artist-header">
    <div class="artist-hero">
      <div class="artist-photo-wrap" id="artistPhoto"></div>
      <div class="artist-info-side">
        <h2 class="artist-name">${name}</h2>
        <div class="artist-years">Active on ${chartLabel()}: ${yearSpan} &bull; ${validWeekCount()} weeks loaded</div>
      </div>
    </div>
    <div class="stat-cards">
      <div class="stat-card"><div class="stat-card-icon">${isAlbum ? 'üíø' : 'üéµ'}</div><div class="stat-card-val">${hl.length}</div><div class="stat-card-label">${isAlbum ? 'Chart Albums' : 'Chart Hits'}</div></div>
      <div class="stat-card"><div class="stat-card-icon">üëë</div><div class="stat-card-val gold-text">${n1}</div><div class="stat-card-label">#1 Hits</div></div>
      <div class="stat-card"><div class="stat-card-icon">üî•</div><div class="stat-card-val">${t10}</div><div class="stat-card-label">Top 10</div></div>
      <div class="stat-card"><div class="stat-card-icon">üìà</div><div class="stat-card-val">#${bp}</div><div class="stat-card-label">Highest Peak</div></div>
      <div class="stat-card"><div class="stat-card-icon">üìÖ</div><div class="stat-card-val">${totalWks}</div><div class="stat-card-label">Total Weeks</div></div>
      <div class="stat-card"><div class="stat-card-icon">üéØ</div><div class="stat-card-val">${t40}</div><div class="stat-card-label">Top 40</div></div>
    </div>
  </div>`;

  // Narrative
  h += artistNarrative(name, hl, n1, t10, totalWks, minY, maxY, isAlbum);

  // ‚îÄ‚îÄ‚îÄ CAREER TIMELINE BAR ‚îÄ‚îÄ‚îÄ
  if (years.length >= 1) {
    const tlMin = minY - 1, tlMax = maxY + 1, tlRange = tlMax - tlMin || 1;
    const pct = (y) => ((y - tlMin) / tlRange * 100).toFixed(1);
    const startPct = pct(minY), endPct = pct(maxY);

    h += `<div class="timeline-section">
      <div class="timeline-title">Career Timeline</div>
      <div class="timeline-bar">
        <div class="timeline-active" style="left:${startPct}%;width:${(endPct - startPct) || 1}%"></div>
        <div class="timeline-dots">`;

    // Place dots for each song
    hl.forEach(hit => {
      if (!hit.firstDate) return;
      const yr = +hit.firstDate.substring(0,4);
      const x = pct(yr);
      const isNo1 = hit.peak === 1;
      h += `<div class="timeline-dot${isNo1 ? ' no1' : ''}" style="left:${x}%" title="${hit.title} (${yr}) - #${hit.peak}"></div>`;
    });

    h += `</div></div>
      <div class="timeline-labels">
        <span>${minY}</span>`;
    // Add middle labels
    const midYears = [];
    const step = Math.max(1, Math.floor((maxY - minY) / 4));
    for (let y = minY + step; y < maxY; y += step) midYears.push(y);
    midYears.forEach(y => { h += `<span>${y}</span>`; });
    h += `<span>${maxY}</span></div></div>`;
  }

  // ‚îÄ‚îÄ‚îÄ PEAK POSITION CHART (SVG) ‚îÄ‚îÄ‚îÄ
  if (hl.length >= 2) {
    const chartW = 860, chartH = 180, padL = 36, padR = 16, padT = 10, padB = 24;
    const plotW = chartW - padL - padR, plotH = chartH - padT - padB;
    const maxPeak = Math.max(...hl.map(h => h.peak));
    const scaleY = (peak) => padT + (peak - 1) / Math.max(maxPeak - 1, 1) * plotH;
    const scaleX = (i) => padL + i / (hl.length - 1) * plotW;

    const artChartId = 'artChart' + Date.now();
    h += `<div class="peak-chart" id="${artChartId}">
      <div class="peak-chart-title">Peak Positions Over Time</div>
      <div class="chart-tooltip" id="${artChartId}Tip"></div>
      <svg viewBox="0 0 ${chartW} ${chartH}" preserveAspectRatio="xMidYMid meet">
        <defs>
          <linearGradient id="areaGrad" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="var(--gold)" stop-opacity=".3"/>
            <stop offset="100%" stop-color="var(--gold)" stop-opacity=".02"/>
          </linearGradient>
        </defs>`;

    // Grid lines at #1, #10, #40, #100
    [1, 10, 40, 100].forEach(v => {
      if (v > maxPeak) return;
      const y = scaleY(v);
      h += `<line x1="${padL}" y1="${y}" x2="${chartW - padR}" y2="${y}" stroke="#222" stroke-width="1"/>`;
      h += `<text x="${padL - 6}" y="${y + 4}" fill="#444" font-size="9" text-anchor="end" font-family="DM Mono,monospace">#${v}</text>`;
    });

    // Area fill
    let areaPath = `M${scaleX(0)},${scaleY(hl[0].peak)}`;
    hl.forEach((hit, i) => { if (i > 0) areaPath += ` L${scaleX(i)},${scaleY(hit.peak)}`; });
    areaPath += ` L${scaleX(hl.length-1)},${chartH - padB} L${scaleX(0)},${chartH - padB} Z`;
    h += `<path d="${areaPath}" fill="url(#areaGrad)"/>`;

    // Line
    let linePath = `M${scaleX(0)},${scaleY(hl[0].peak)}`;
    hl.forEach((hit, i) => { if (i > 0) linePath += ` L${scaleX(i)},${scaleY(hit.peak)}`; });
    h += `<path d="${linePath}" fill="none" stroke="var(--gold)" stroke-width="2" stroke-linejoin="round"/>`;

    // Dots
    hl.forEach((hit, i) => {
      const cx = scaleX(i), cy = scaleY(hit.peak);
      const fill = hit.peak === 1 ? 'var(--gold)' : hit.peak <= 10 ? '#fff' : '#888';
      const r = hit.peak === 1 ? 5 : hit.peak <= 10 ? 3.5 : 2.5;
      h += `<circle cx="${cx}" cy="${cy}" r="${r}" fill="${fill}" stroke="${hit.peak === 1 ? '#111' : 'none'}" stroke-width="${hit.peak === 1 ? 1.5 : 0}"/>`;
      // Label #1 hits
      if (hit.peak === 1) {
        const label = hit.title.length > 18 ? hit.title.substring(0,16) + '‚Ä¶' : hit.title;
        h += `<text x="${cx}" y="${cy - 10}" fill="var(--gold)" font-size="8" text-anchor="middle" font-family="DM Sans,sans-serif" font-weight="700">${label}</text>`;
      }
    });

    // Invisible overlay for mouse/touch tracking
    h += `<rect x="${padL}" y="${padT}" width="${plotW}" height="${plotH}" fill="transparent" style="cursor:crosshair" class="chart-hit-area"/>`;

    // Year labels along bottom
    const seenYears = new Set();
    hl.forEach((hit, i) => {
      if (!hit.firstDate) return;
      const yr = hit.firstDate.substring(0,4);
      if (!seenYears.has(yr)) {
        seenYears.add(yr);
        h += `<text x="${scaleX(i)}" y="${chartH - 4}" fill="#444" font-size="9" text-anchor="middle" font-family="DM Mono,monospace">${yr}</text>`;
      }
    });

    h += `</svg></div>`;

    // Wire up artist chart tooltip
    const _hlData = hl.map((h,i) => ({i, peak: h.peak, title: h.title, year: h.firstDate ? h.firstDate.substring(0,4) : ''}));
    const _hlLen = _hlData.length;
    const _acW = chartW, _apL = padL, _apW = plotW;
    const _artChartId = artChartId;
    setTimeout(() => {
      const container = document.getElementById(_artChartId);
      if (!container) return;
      const svg = container.querySelector('svg');
      const tip = document.getElementById(_artChartId + 'Tip');
      const hitArea = container.querySelector('.chart-hit-area');
      if (!svg || !tip || !hitArea) return;

      function showTip(clientX, clientY) {
        const rect = svg.getBoundingClientRect();
        const relX = (clientX - rect.left) / rect.width;
        const svgX = relX * _acW;
        let nearest = 0, minDist = Infinity;
        for (let j = 0; j < _hlLen; j++) {
          const dotX = _apL + j / Math.max(_hlLen - 1, 1) * _apW;
          const d = Math.abs(svgX - dotX);
          if (d < minDist) { minDist = d; nearest = j; }
        }
        const item = _hlData[nearest];
        const tTitle = item.title.length > 30 ? item.title.substring(0,28) + '‚Ä¶' : item.title;
        tip.innerHTML = '<span class="tt-rank">#' + item.peak + '</span>  ' + tTitle + '<br><span class="tt-date">' + item.year + '</span>';
        tip.classList.add('visible');
        const tipX = (clientX - rect.left) + 14;
        const tipY = (clientY - rect.top) - 36;
        tip.style.left = Math.min(tipX, rect.width - 180) + 'px';
        tip.style.top = Math.max(tipY, 0) + 'px';
      }

      function hideTip() { tip.classList.remove('visible'); }

      hitArea.addEventListener('mousemove', e => showTip(e.clientX, e.clientY));
      hitArea.addEventListener('mouseleave', hideTip);
      hitArea.addEventListener('touchmove', e => { e.preventDefault(); const t = e.touches[0]; showTip(t.clientX, t.clientY); }, { passive: false });
      hitArea.addEventListener('touchend', hideTip);
    }, 100);
  }

  // ‚îÄ‚îÄ‚îÄ ITEMS GROUPED BY DECADE ‚îÄ‚îÄ‚îÄ
  const decades = new Map();
  hl.forEach(hit => {
    const yr = hit.firstDate ? +hit.firstDate.substring(0,4) : 0;
    const dec = Math.floor(yr / 10) * 10;
    const label = dec < 1960 ? 'Late 50s' : dec + 's';
    if (!decades.has(label)) decades.set(label, []);
    decades.get(label).push(hit);
  });

  const il = itemLabel(false);
  for (const [decLabel, songs] of decades) {
    const decNo1 = songs.filter(s => s.peak === 1).length;
    const decT10 = songs.filter(s => s.peak <= 10).length;
    h += `<div class="decade-group">
      <div class="decade-header">
        <span class="decade-label">${decLabel}</span>
        <div class="decade-line"></div>
        <span class="decade-count">${songs.length} ${songs.length !== 1 ? itemLabel(true) : il}${decNo1 ? ' &bull; ' + decNo1 + ' #1' : ''}${decT10 && !decNo1 ? ' &bull; ' + decT10 + ' top 10' : ''}</span>
      </div>
      <div class="chart-list">`;

    songs.forEach((hit, i) => {
      const cls = hit.peak === 1 ? 'gold' : hit.peak <= 3 ? 'silver' : hit.peak <= 10 ? 'bronze' : 'normal';
      const bg = cls === 'gold' ? 'background:var(--gold);color:#111;' : cls === 'silver' ? 'background:#c0c0c0;color:#111;' : cls === 'bronze' ? 'background:#cd7f32;color:#111;' : 'background:rgba(255,255,255,.06);color:#aaa;';
      // Position bar showing relative peak (visual bar behind entry)
      const barWidth = Math.max(2, (1 - (hit.peak - 1) / 100) * 100);
      const barColor = hit.peak === 1 ? 'rgba(212,175,55,.12)' : hit.peak <= 10 ? 'rgba(212,175,55,.06)' : 'rgba(255,255,255,.02)';

      h += `<div class="chart-entry" style="animation-delay:${Math.min(i,15)*30}ms;position:relative;overflow:hidden">
        <div style="position:absolute;left:0;top:0;height:100%;width:${barWidth}%;background:${barColor};pointer-events:none;transition:width .6s"></div>
        <div class="rank-badge ${cls}" style="${bg};position:relative;z-index:1">${hit.peak}</div>
        <div class="entry-info" style="position:relative;z-index:1">
          <div class="entry-title clickable" onclick="searchFor('${esc(hit.title)}','${esc(name)}')">${hit.title}</div>
          <div class="entry-meta">
            <span style="font-size:12px;color:var(--text-dim)">${hit.firstDate ? hit.firstDate.substring(0,4) : ''}</span>
            <span style="font-size:11px;color:#555">${hit.weeks ? hit.weeks + ' wks' : ''}</span>
          </div>
        </div>
        <div style="position:relative;z-index:1">${hit.peak === 1 ? '<span class="no1-tag">üëë #1</span>' : hit.peak <= 10 ? '<span style="font-size:10px;color:#666">Top 10</span>' : ''}</div>
      </div>`;
      if (i < songs.length - 1) h += '<div class="chart-divider"></div>';
    });

    h += '</div></div>';
  }

  c.innerHTML = h;
  window.scrollTo(0, 0);
  // Fetch artist image async
  fetchArtistImage(name, 'artistPhoto');
}

function goToArtist(n) { document.getElementById('artistInput').value = n; switchView('artist'); showArtist(n); }

function goToWeek(date) {
  if (chartType === 'billboard200') {
    document.getElementById('albumDateSelect').value = date;
    switchView('weekly');
    loadAlbumChartWeek();
  } else {
    document.getElementById('dateSelect').value = date;
    switchView('weekly');
    loadChartWeek();
  }
}

function searchFor(title, artist) {
  // If we have both title and artist, show the song detail view
  if (title && artist) {
    showSong(title, artist);
    return;
  }
  // Otherwise fall back to search
  document.getElementById('searchInput').value = title;
  searchFilter = 'song';
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.toggle('active', b.dataset.filter === 'song'));
  switchView('search');
  doSearch();
}

function showSong(title, artist) {
  // Find every week this song/album appeared on the chart
  const cache = activeCache();
  const isAlbum = chartType === 'billboard200';
  const weeks = [];
  for (const [date, entries] of Object.entries(cache)) {
    if (!Array.isArray(entries)) continue;
    try {
      for (const e of entries) {
        if (!e) continue;
        if (e.title === title && e.artist === artist) {
          weeks.push({ date, rank: e.rank, lastWeek: e.lastWeek, peak: e.peak, weeks: e.weeks });
        }
      }
    } catch(err) {}
  }

  weeks.sort((a, b) => a.date.localeCompare(b.date));

  const peakPos = weeks.length ? Math.min(...weeks.map(w => w.rank || 999)) : 0;
  const maxWks = weeks.length ? Math.max(...weeks.map(w => w.weeks || 0)) : 0;
  const peakWeek = weeks.find(w => w.rank === peakPos);

  const c = document.getElementById('songContent');
  let h = `<button class="back-btn" onclick="switchView(previousView)">‚óÄ Back</button>`;

  h += `<div class="song-header">
    <div class="song-hero">
      <div class="song-art-wrap" id="songArt"></div>
      <div class="song-info-side">
        <div class="song-title-big">${title}</div>
        <div class="song-artist-big" onclick="goToArtist('${esc(artist)}')">${artist}</div>
        <div class="song-stats-row">
          <div><div class="artist-stat-val">#${peakPos}</div><div class="artist-stat-label">Peak Position</div></div>
          <div><div class="artist-stat-val">${maxWks}</div><div class="artist-stat-label">Weeks on Chart</div></div>
          <div><div class="artist-stat-val">${weeks.length}</div><div class="artist-stat-label">Weeks Found</div></div>
          ${peakWeek ? `<div><div class="artist-stat-val" style="font-size:16px">${fmtDate(peakWeek.date)}</div><div class="artist-stat-label">Reached #${peakPos}</div></div>` : ''}
        </div>
      </div>
    </div>
  </div>`;

  // Narrative
  h += songNarrative(title, artist, weeks, peakPos, maxWks, isAlbum);

  // Credits placeholder (filled async by MusicBrainz) - songs only
  if (!isAlbum) h += `<div id="songCredits"></div>`;

  // Album: track list + credits placeholders
  if (isAlbum) {
    h += `<div id="albumTracks"></div>`;
    h += `<div id="albumCredits"></div>`;
  }

  if (weeks.length === 0) {
    h += `<div class="empty"><div class="empty-icon">üîá</div><p>No weekly data found</p><p class="sub">${chartType === 'hot100' ? 'Load more decades for a complete chart run' : 'Make sure Billboard 200 data is loaded'}</p></div>`;
  } else {
    // ‚îÄ‚îÄ‚îÄ CHART POSITION LINE GRAPH ‚îÄ‚îÄ‚îÄ
    if (weeks.length >= 2) {
      // Find other entries by same artist on chart during these weeks
      const siblingColors = ['#5b8abd','#b05ca6','#5bbd7a','#bd7a5b','#8a8abd'];
      const siblingMap = {}; // { title: { date: rank, ... } }
      const weekDates = new Set(weeks.map(w => w.date));
      for (const date of weekDates) {
        const entries = cache[date];
        if (!Array.isArray(entries)) continue;
        for (const e of entries) {
          if (!e || !e.artist || !e.title) continue;
          if (e.artist === artist && e.title !== title) {
            if (!siblingMap[e.title]) siblingMap[e.title] = {};
            siblingMap[e.title][date] = e.rank;
          }
        }
      }
      // Convert to array sorted by most weeks on chart, limit to 5
      const siblings = Object.entries(siblingMap)
        .map(([t, dates]) => ({ title: t, dates }))
        .sort((a, b) => Object.keys(b.dates).length - Object.keys(a.dates).length)
        .slice(0, 5);

      const chartW = 860, chartH = 200, padL = 38, padR = 16, padT = 14, padB = 28;
      const plotW = chartW - padL - padR, plotH = chartH - padT - padB;
      // Include sibling ranks in maxR so scale covers everything
      let allRanks = weeks.map(w => w.rank || 100);
      siblings.forEach(s => { Object.values(s.dates).forEach(r => allRanks.push(r)); });
      const maxR = Math.max(...allRanks);
      const chartMax = isAlbum ? 200 : 100;
      const scaleY = (rank) => padT + (rank - 1) / Math.max(maxR - 1, 1) * plotH;
      const scaleX = (i) => padL + i / (weeks.length - 1) * plotW;

      const chartId = 'posChart' + Date.now();
      h += `<div class="peak-chart" id="${chartId}">
        <div class="peak-chart-title">Chart Position</div>
        <div class="chart-tooltip" id="${chartId}Tip"></div>
        <svg viewBox="0 0 ${chartW} ${chartH}" preserveAspectRatio="xMidYMid meet">
          <defs>
            <linearGradient id="songAreaGrad" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stop-color="var(--gold)" stop-opacity=".35"/>
              <stop offset="100%" stop-color="var(--gold)" stop-opacity=".02"/>
            </linearGradient>
          </defs>`;

      // Grid lines
      const gridVals = isAlbum ? [1, 10, 20, 40, 60, 80, 100, 150, 200] : [1, 10, 20, 40, 60, 80, 100];
      gridVals.forEach(v => {
        if (v > maxR) return;
        const y = scaleY(v);
        h += `<line x1="${padL}" y1="${y}" x2="${chartW - padR}" y2="${y}" stroke="#222" stroke-width="1"/>`;
        h += `<text x="${padL - 6}" y="${y + 4}" fill="#444" font-size="9" text-anchor="end" font-family="DM Mono,monospace">#${v}</text>`;
      });

      // ‚îÄ‚îÄ‚îÄ Sibling lines (drawn first so they appear behind) ‚îÄ‚îÄ‚îÄ
      siblings.forEach((sib, si) => {
        const color = siblingColors[si % siblingColors.length];
        // Build segments (only draw where sibling is on chart)
        let segments = [], seg = [];
        weeks.forEach((w, i) => {
          const r = sib.dates[w.date];
          if (r !== undefined) {
            seg.push({ i, rank: r });
          } else {
            if (seg.length > 1) segments.push(seg);
            seg = [];
          }
        });
        if (seg.length > 1) segments.push(seg);

        // Draw each continuous segment
        segments.forEach(pts => {
          let path = `M${scaleX(pts[0].i)},${scaleY(pts[0].rank)}`;
          for (let k = 1; k < pts.length; k++) {
            path += ` L${scaleX(pts[k].i)},${scaleY(pts[k].rank)}`;
          }
          h += `<path d="${path}" fill="none" stroke="${color}" stroke-width="1.5" stroke-opacity=".4" stroke-linejoin="round" stroke-dasharray="4,3"/>`;
        });

        // Small dots at each point
        weeks.forEach((w, i) => {
          const r = sib.dates[w.date];
          if (r !== undefined) {
            h += `<circle cx="${scaleX(i)}" cy="${scaleY(r)}" r="2" fill="${color}" fill-opacity=".5"/>`;
          }
        });
      });

      // ‚îÄ‚îÄ‚îÄ Main entry area fill ‚îÄ‚îÄ‚îÄ
      let areaPath = `M${scaleX(0)},${scaleY(weeks[0].rank)}`;
      weeks.forEach((w, i) => { if (i > 0) areaPath += ` L${scaleX(i)},${scaleY(w.rank)}`; });
      areaPath += ` L${scaleX(weeks.length-1)},${chartH - padB} L${scaleX(0)},${chartH - padB} Z`;
      h += `<path d="${areaPath}" fill="url(#songAreaGrad)"/>`;

      // ‚îÄ‚îÄ‚îÄ Main entry line ‚îÄ‚îÄ‚îÄ
      let linePath = `M${scaleX(0)},${scaleY(weeks[0].rank)}`;
      weeks.forEach((w, i) => { if (i > 0) linePath += ` L${scaleX(i)},${scaleY(w.rank)}`; });
      h += `<path d="${linePath}" fill="none" stroke="var(--gold)" stroke-width="2.5" stroke-linejoin="round" stroke-linecap="round"/>`;

      // Dots + peak label
      weeks.forEach((w, i) => {
        const cx = scaleX(i), cy = scaleY(w.rank);
        const isP = w.rank === peakPos;
        const fill = w.rank === 1 ? 'var(--gold)' : w.rank <= 10 ? '#fff' : '#aaa';
        const r = isP ? 5 : w.rank <= 10 ? 3.5 : 2.5;
        h += `<circle cx="${cx}" cy="${cy}" r="${r}" fill="${fill}" stroke="${isP ? '#111' : 'none'}" stroke-width="${isP ? 1.5 : 0}"/>`;
        if (isP && i === weeks.indexOf(weeks.find(wk => wk.rank === peakPos))) {
          h += `<text x="${cx}" y="${cy - 10}" fill="var(--gold)" font-size="10" text-anchor="middle" font-family="DM Mono,monospace" font-weight="700">#${peakPos}</text>`;
        }
      });

      // Invisible overlay for mouse/touch tracking
      h += `<rect x="${padL}" y="${padT}" width="${plotW}" height="${plotH}" fill="transparent" style="cursor:crosshair" class="chart-hit-area"/>`;

      // Week labels along bottom
      const labelStep = weeks.length <= 12 ? 1 : weeks.length <= 26 ? 2 : Math.ceil(weeks.length / 12);
      weeks.forEach((w, i) => {
        if (i % labelStep === 0 || i === weeks.length - 1) {
          const label = w.date.substring(5, 10).replace('-', '/');
          h += `<text x="${scaleX(i)}" y="${chartH - 6}" fill="#444" font-size="8" text-anchor="middle" font-family="DM Mono,monospace">${label}</text>`;
        }
      });

      h += `</svg>`;

      // Legend for siblings
      if (siblings.length > 0) {
        h += `<div style="display:flex;flex-wrap:wrap;gap:10px 16px;margin-top:8px;padding:0 4px">`;
        h += `<span style="font-size:10px;color:#666;display:flex;align-items:center;gap:4px"><span style="display:inline-block;width:12px;height:3px;background:var(--gold);border-radius:1px"></span> ${title.length > 30 ? title.substring(0,28)+'‚Ä¶' : title}</span>`;
        siblings.forEach((sib, si) => {
          const color = siblingColors[si % siblingColors.length];
          const sTitle = sib.title.length > 30 ? sib.title.substring(0,28)+'‚Ä¶' : sib.title;
          h += `<span style="font-size:10px;color:#666;display:flex;align-items:center;gap:4px;cursor:pointer" onclick="showSong('${esc(sib.title)}','${esc(artist)}')"><span style="display:inline-block;width:12px;height:3px;background:${color};opacity:.6;border-radius:1px"></span> ${sTitle}</span>`;
        });
        h += `</div>`;
      }

      h += `</div>`;

      // Wire up tooltip after render (with sibling data)
      const _weekData = weeks.map((w,i) => ({i, rank: w.rank, date: w.date, wk: i+1}));
      const _sibData = siblings.map((s,si) => ({
        title: s.title,
        color: siblingColors[si % siblingColors.length],
        dates: s.dates
      }));
      const _wLen = _weekData.length;
      const _cW = chartW, _pL = padL, _pW = plotW;
      const _chartId = chartId;
      setTimeout(() => {
        const container = document.getElementById(_chartId);
        if (!container) return;
        const svg = container.querySelector('svg');
        const tip = document.getElementById(_chartId + 'Tip');
        const hitArea = container.querySelector('.chart-hit-area');
        if (!svg || !tip || !hitArea) return;

        function showTip(clientX, clientY) {
          const rect = svg.getBoundingClientRect();
          const relX = (clientX - rect.left) / rect.width;
          const svgX = relX * _cW;
          let nearest = 0, minDist = Infinity;
          for (let j = 0; j < _wLen; j++) {
            const dotX = _pL + j / Math.max(_wLen - 1, 1) * _pW;
            const d = Math.abs(svgX - dotX);
            if (d < minDist) { minDist = d; nearest = j; }
          }
          const w = _weekData[nearest];
          let html = '<span class="tt-rank">#' + w.rank + '</span>  Week ' + w.wk;
          // Show siblings at this date
          for (const s of _sibData) {
            const sr = s.dates[w.date];
            if (sr !== undefined) {
              const st = s.title.length > 22 ? s.title.substring(0,20)+'‚Ä¶' : s.title;
              html += '<br><span style="color:' + s.color + ';font-size:10px">#' + sr + ' ' + st + '</span>';
            }
          }
          html += '<br><span class="tt-date">' + w.date + '</span>';
          tip.innerHTML = html;
          tip.classList.add('visible');
          const tipX = (clientX - rect.left) + 14;
          const tipY = (clientY - rect.top) - 36;
          tip.style.left = Math.min(tipX, rect.width - 160) + 'px';
          tip.style.top = Math.max(tipY, 0) + 'px';
        }

        function hideTip() { tip.classList.remove('visible'); }

        hitArea.addEventListener('mousemove', e => showTip(e.clientX, e.clientY));
        hitArea.addEventListener('mouseleave', hideTip);
        hitArea.addEventListener('touchmove', e => {
          e.preventDefault();
          const t = e.touches[0];
          showTip(t.clientX, t.clientY);
        }, { passive: false });
        hitArea.addEventListener('touchend', hideTip);
      }, 100);
    }

    h += `<div class="sort-label">Week-by-week chart run &bull; ${weeks.length} weeks found</div>`;
    h += '<div class="chart-list">';
    weeks.forEach((w, i) => {
      const cls = w.rank === 1 ? 'gold' : w.rank <= 3 ? 'silver' : w.rank <= 10 ? 'top10' : 'normal';
      const lw = w.lastWeek;
      let mi = '‚òÖ', mc = 'var(--new)';
      if (lw) { if (lw > w.rank) { mi = '‚ñ≤'; mc = 'var(--up)'; } else if (lw < w.rank) { mi = '‚ñº'; mc = 'var(--down)'; } else { mi = '‚ñ†'; mc = 'var(--same)'; } }

      h += `<div class="week-row" style="animation-delay:${Math.min(i,25)*20}ms">
        <div class="rank-badge ${cls}">${w.rank}</div>
        <div class="week-date" onclick="goToWeek('${w.date}')">${fmtDate(w.date)}</div>
        <div class="entry-stats">
          ${lw ? `<div class="stat-col"><div class="stat-header">LW</div><div class="stat-val">${lw}</div></div>` : '<div class="stat-col"><div class="stat-header">LW</div><div class="stat-val">‚Äî</div></div>'}
          ${w.peak ? `<div class="stat-col"><div class="stat-header">PK</div><div class="stat-val">${w.peak}</div></div>` : ''}
          ${w.weeks ? `<div class="stat-col"><div class="stat-header">WK</div><div class="stat-val">${w.weeks}</div></div>` : ''}
          <div class="movement" style="color:${mc}">${mi}</div>
        </div>
      </div>`;
      if (i < weeks.length - 1) h += '<div class="chart-divider"></div>';
    });
    h += '</div>';
  }

  c.innerHTML = h;
  switchView('song');
  window.scrollTo(0, 0);
  // Fetch album art async (for both songs and albums)
  fetchSongImage(title, artist, 'songArt');
  // Fetch credits only for songs
  if (!isAlbum) fetchSongCredits(title, artist, 'songCredits');
  // Fetch track list + credits for albums
  if (isAlbum) {
    const albumYear = weeks.length ? +weeks[0].date.substring(0,4) : 0;
    fetchAlbumTracks(title, artist, albumYear, 'albumTracks');
    fetchAlbumCredits(title, artist, albumYear, 'albumCredits');
  }
}

// ‚îÄ‚îÄ‚îÄ ALBUM TRACKS (iTunes) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const albumTracksCache = {};

async function fetchAlbumTracks(title, artist, albumYear, elementId) {
  const el = document.getElementById(elementId);
  if (!el) return;
  const key = title + '|' + artist + '|' + albumYear;
  if (albumTracksCache[key]) { renderAlbumTracks(el, albumTracksCache[key]); return; }

  el.innerHTML = `<div class="tracklist-section loading"><div class="tracklist-title">Track List</div><div style="font-size:12px;color:var(--text-faint)">Looking up tracks...</div></div>`;

  try {
    // Search iTunes for the album
    const searchUrl = `https://itunes.apple.com/search?term=${encodeURIComponent(title + ' ' + artist)}&entity=album&limit=15`;
    const r1 = await fetch(searchUrl);
    if (!r1.ok) throw new Error('iTunes search: ' + r1.status);
    const searchData = await r1.json();
    if (!searchData.results || searchData.results.length === 0) { el.innerHTML = ''; return; }

    // Find best matching album, using year to disambiguate
    const titleLow = title.toLowerCase().replace(/[^a-z0-9]/g, '');
    const artistLow = artist.toLowerCase().replace(/[^a-z0-9]/g, '');

    // Score each result
    let bestMatch = null, bestScore = -1;
    for (const r of searchData.results) {
      const rTitle = (r.collectionName || '').toLowerCase().replace(/[^a-z0-9]/g, '');
      const rArtist = (r.artistName || '').toLowerCase().replace(/[^a-z0-9]/g, '');
      const rYear = r.releaseDate ? +r.releaseDate.substring(0, 4) : 0;
      let score = 0;

      // Title match
      if (rTitle === titleLow) score += 10;
      else if (rTitle.includes(titleLow) || titleLow.includes(rTitle)) score += 5;
      else continue; // skip non-matching titles

      // Artist match
      if (rArtist === artistLow) score += 5;
      else if (rArtist.includes(artistLow) || artistLow.includes(rArtist)) score += 3;

      // Year match (albums typically chart the year of or year after release)
      if (albumYear && rYear) {
        if (rYear === albumYear) score += 8;
        else if (rYear === albumYear - 1) score += 6;
        else if (Math.abs(rYear - albumYear) <= 2) score += 3;
        else score -= 2; // penalize distant years
      }

      if (score > bestScore) { bestScore = score; bestMatch = r; }
    }

    if (!bestMatch) { el.innerHTML = ''; return; }

    const collectionId = bestMatch.collectionId;
    if (!collectionId) { el.innerHTML = ''; return; }

    // Lookup album tracks
    const lookupUrl = `https://itunes.apple.com/lookup?id=${collectionId}&entity=song&limit=200`;
    const r2 = await fetch(lookupUrl);
    if (!r2.ok) throw new Error('iTunes lookup: ' + r2.status);
    const lookupData = await r2.json();

    if (!lookupData.results || lookupData.results.length < 2) { el.innerHTML = ''; return; }

    // First result is the collection, rest are tracks
    const albumInfo = lookupData.results[0];
    const tracks = lookupData.results.slice(1).filter(t => t.wrapperType === 'track');

    const data = {
      albumName: albumInfo.collectionName || title,
      artistName: albumInfo.artistName || artist,
      releaseDate: albumInfo.releaseDate || '',
      genre: albumInfo.primaryGenreName || '',
      trackCount: albumInfo.trackCount || tracks.length,
      label: albumInfo.copyright || '',
      tracks: tracks.map(t => ({
        num: t.trackNumber || 0,
        disc: t.discNumber || 1,
        name: t.trackName || '',
        duration: t.trackTimeMillis || 0,
        artist: t.artistName || ''
      }))
    };

    albumTracksCache[key] = data;
    renderAlbumTracks(el, data);
  } catch(e) {
    console.error('Album tracks error:', e);
    el.innerHTML = '';
  }
}

function renderAlbumTracks(el, data) {
  if (!data.tracks || data.tracks.length === 0) { el.innerHTML = ''; return; }

  const fmtMs = (ms) => {
    if (!ms) return '';
    const s = Math.floor(ms / 1000);
    return Math.floor(s / 60) + ':' + String(s % 60).padStart(2, '0');
  };

  const totalMs = data.tracks.reduce((s, t) => s + (t.duration || 0), 0);
  const maxDisc = Math.max(...data.tracks.map(t => t.disc || 1));

  let h = `<div class="tracklist-section">`;
  h += `<div class="tracklist-title">Track List <span class="track-count">${data.tracks.length} tracks${totalMs ? ' ¬∑ ' + fmtMs(totalMs) : ''}</span></div>`;

  // Album meta
  const metaParts = [];
  if (data.releaseDate) {
    const yr = data.releaseDate.substring(0, 4);
    const fullDate = new Date(data.releaseDate);
    const dateStr = !isNaN(fullDate) ? fullDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) : yr;
    metaParts.push(`<span>Released</span>${dateStr}`);
  }
  if (data.genre) metaParts.push(`<span>Genre</span>${data.genre}`);
  if (data.label) {
    const cleanLabel = data.label.replace(/^‚Ñó\s*\d{4}\s*/, '').replace(/^¬©\s*\d{4}\s*/, '').trim();
    if (cleanLabel) metaParts.push(`<span>Label</span>${cleanLabel}`);
  }
  if (metaParts.length) h += `<div class="album-meta-row">${metaParts.join('')}</div>`;

  // Tracks, grouped by disc if multi-disc
  if (maxDisc > 1) {
    for (let d = 1; d <= maxDisc; d++) {
      const discTracks = data.tracks.filter(t => t.disc === d);
      if (discTracks.length === 0) continue;
      h += `<div class="track-disc-label">Disc ${d}</div>`;
      discTracks.forEach(t => {
        h += `<div class="track-item"><div class="track-num">${t.num}</div><div class="track-name">${t.name}</div><div class="track-duration">${fmtMs(t.duration)}</div></div>`;
      });
    }
  } else {
    data.tracks.forEach(t => {
      h += `<div class="track-item"><div class="track-num">${t.num}</div><div class="track-name">${t.name}</div><div class="track-duration">${fmtMs(t.duration)}</div></div>`;
    });
  }

  h += `</div>`;
  el.innerHTML = h;
}

// ‚îÄ‚îÄ‚îÄ ALBUM CREDITS (MusicBrainz) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const albumCreditsCache = {};

async function fetchAlbumCredits(title, artist, albumYear, elementId) {
  const el = document.getElementById(elementId);
  if (!el) return;
  const key = title + '|' + artist + '|' + albumYear;
  if (albumCreditsCache[key]) { renderAlbumCredits(el, albumCreditsCache[key]); return; }

  el.innerHTML = `<div class="credits-section loading"><div class="credits-title">Credits</div><div style="font-size:12px;color:var(--text-faint)">Looking up producers & credits...</div></div>`;

  try {
    let producers = [], engineers = [], mixers = [], writers = [], arrangers = [], performers = [];
    let labelNames = [];

    // Step 1: Search for the release (same query format as working song credits)
    const q = encodeURIComponent(title) + '%20AND%20artist:' + encodeURIComponent(artist);
    const r1 = await fetch('https://musicbrainz.org/ws/2/release?query=' + q + '&fmt=json&limit=10');
    if (!r1.ok) throw new Error('MB search: ' + r1.status);
    const search = await r1.json();

    if (!search.releases || search.releases.length === 0) { el.innerHTML = ''; return; }

    // Find best matching release using title + year
    const titleLow = title.toLowerCase();
    let bestRelease = null, bestScore = -1;
    for (const rel of search.releases) {
      const rTitle = (rel.title || '').toLowerCase();
      const rDate = rel.date || '';
      const rYear = rDate ? +rDate.substring(0, 4) : 0;
      let score = 0;
      if (rTitle === titleLow) score += 10;
      else if (rTitle.includes(titleLow) || titleLow.includes(rTitle)) score += 5;
      else continue;
      if (albumYear && rYear) {
        if (rYear === albumYear || rYear === albumYear - 1) score += 8;
        else if (Math.abs(rYear - albumYear) <= 2) score += 4;
      }
      if (rel.status === 'Official') score += 2;
      if (rel['track-count'] && rel['track-count'] > 5) score += 1;
      if (score > bestScore) { bestScore = score; bestRelease = rel; }
    }

    if (!bestRelease) bestRelease = search.releases[0];

    // Step 2: Fetch release with recording-level-rels (this is where credits live!)
    // MusicBrainz stores producer/engineer/mixer credits on individual recordings,
    // not on the release itself. recording-level-rels pulls all track-level credits.
    await sleep(1100);
    const r2 = await fetch(`https://musicbrainz.org/ws/2/release/${bestRelease.id}?inc=recordings+artist-rels+recording-level-rels+label-rels&fmt=json`);
    if (!r2.ok) throw new Error('MB release: ' + r2.status);
    const relData = await r2.json();

    // Helper to collect credits from a relations array
    function collectCredits(rels) {
      if (!rels) return;
      for (const rel of rels) {
        if (!rel.artist) continue;
        const t = (rel.type || '').toLowerCase();
        const name = rel.artist.name;
        if (!name) continue;
        if (t === 'producer' || t === 'co-producer') { if (!producers.includes(name)) producers.push(name); }
        else if (t === 'engineer' || t === 'recording' || t === 'balance' || t === 'audio') { if (!engineers.includes(name)) engineers.push(name); }
        else if (t === 'mix' || t === 'mixer' || t === 'remixer') { if (!mixers.includes(name)) mixers.push(name); }
        else if (t === 'mastering') { if (!mixers.includes(name + ' (mastering)')) mixers.push(name + ' (mastering)'); }
        else if (t === 'writer' || t === 'composer' || t === 'lyricist') { if (!writers.includes(name)) writers.push(name); }
        else if (t.includes('arranger') || t.includes('orchestrat')) { if (!arrangers.includes(name)) arrangers.push(name); }
        else if (t === 'instrument' || t === 'vocal' || t === 'performer' || t === 'performing orchestra' || t === 'conductor') {
          const attr = rel.attributes && rel.attributes.length ? rel.attributes.join(', ') : t;
          if (!performers.find(p => p.name === name)) performers.push({ name, role: attr });
        }
      }
    }

    // Collect release-level credits
    collectCredits(relData.relations);

    // Collect recording-level credits (the main source of producer/engineer data)
    if (relData.media) {
      for (const medium of relData.media) {
        if (medium.tracks) {
          for (const track of medium.tracks) {
            if (track.recording && track.recording.relations) {
              collectCredits(track.recording.relations);
            }
          }
        }
      }
    }

    // Extract label info
    if (relData['label-info'] && relData['label-info'].length > 0) {
      labelNames = relData['label-info'].map(li => li.label ? li.label.name : '').filter(Boolean);
    }

    const credits = {
      producers, engineers, mixers, writers, arrangers, performers,
      label: labelNames.length ? [...new Set(labelNames)].join(' / ') : '',
      others: []
    };
    albumCreditsCache[key] = credits;
    renderAlbumCredits(el, credits);
  } catch(e) {
    console.error('Album credits error:', e);
    el.innerHTML = '';
  }
}

function renderAlbumCredits(el, credits) {
  const hasAny = credits.producers.length || credits.engineers.length || credits.mixers.length ||
    credits.writers.length || credits.arrangers.length || (credits.performers && credits.performers.length) || credits.label;
  if (!hasAny) { el.innerHTML = ''; return; }

  let h = `<div class="credits-section"><div class="credits-title">Credits</div>`;
  if (credits.producers.length) h += `<div class="credits-row"><div class="credits-label">Produced by</div><div class="credits-names">${credits.producers.map(n => `<span>${n}</span>`).join(', ')}</div></div>`;
  if (credits.writers.length) h += `<div class="credits-row"><div class="credits-label">Written by</div><div class="credits-names">${credits.writers.map(n => `<span>${n}</span>`).join(', ')}</div></div>`;
  if (credits.arrangers.length) h += `<div class="credits-row"><div class="credits-label">Arranged by</div><div class="credits-names">${credits.arrangers.map(n => `<span>${n}</span>`).join(', ')}</div></div>`;
  if (credits.engineers.length) h += `<div class="credits-row"><div class="credits-label">Engineered by</div><div class="credits-names">${credits.engineers.map(n => `<span>${n}</span>`).join(', ')}</div></div>`;
  if (credits.mixers.length) h += `<div class="credits-row"><div class="credits-label">Mixed / Mastered</div><div class="credits-names">${credits.mixers.map(n => `<span>${n}</span>`).join(', ')}</div></div>`;
  if (credits.performers && credits.performers.length) {
    h += `<div class="credits-row"><div class="credits-label">Musicians</div><div class="credits-names">${credits.performers.map(p => `<span>${p.name}</span> <span style="color:#555;font-size:11px">(${p.role})</span>`).join(', ')}</div></div>`;
  }
  if (credits.label) h += `<div class="credits-row"><div class="credits-label">Label</div><div class="credits-names"><span>${credits.label}</span></div></div>`;
  h += `</div>`;
  el.innerHTML = h;
}


// ‚îÄ‚îÄ‚îÄ ITUNES IMAGES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const imgCache = {};
const creditsCache = {};

async function fetchSongCredits(title, artist, elementId) {
  const key = title + '|' + artist;
  const el = document.getElementById(elementId);
  if (!el) return;

  if (creditsCache[key]) { renderCredits(el, creditsCache[key]); return; }

  el.innerHTML = `<div class="credits-section loading"><div class="credits-title">Credits</div><div style="font-size:12px;color:var(--text-faint)">Looking up writers & producers...</div></div>`;

  try {
    // Step 1: Search for the recording
    const q = encodeURIComponent(title) + '%20AND%20artist:' + encodeURIComponent(artist);
    const searchUrl = 'https://musicbrainz.org/ws/2/recording?query=' + q + '&fmt=json&limit=5';
    const r1 = await fetch(searchUrl);
    if (!r1.ok) throw new Error('search ' + r1.status);
    const search = await r1.json();

    if (!search.recordings || search.recordings.length === 0) { el.innerHTML = ''; return; }

    // Find best match
    const titleLow = title.toLowerCase();
    const rec = search.recordings.find(r =>
      r.title && r.title.toLowerCase() === titleLow
    ) || search.recordings.find(r =>
      r.title && r.title.toLowerCase().includes(titleLow.substring(0, Math.min(10, titleLow.length)))
    ) || search.recordings[0];

    // Step 2: Get recording with BOTH artist-rels and work-rels
    await sleep(1100);
    const recUrl = `https://musicbrainz.org/ws/2/recording/${rec.id}?inc=artist-rels+work-rels&fmt=json`;
    const r2 = await fetch(recUrl);
    if (!r2.ok) throw new Error('rec ' + r2.status);
    const recData = await r2.json();

    let writers = [], producers = [], arrangers = [];

    // Extract producers, arrangers from recording relationships
    if (recData.relations) {
      for (const rel of recData.relations) {
        if (!rel.artist) continue;
        const name = rel.artist.name;
        const t = (rel.type || '').toLowerCase();
        if (t === 'producer' || t === 'co-producer') producers.push(name);
        else if (t.includes('arranger')) arrangers.push(name);
      }
    }

    // Step 3: Get writers from linked works
    // work-rels on a recording gives us relations of type "performance" pointing to works
    const workIds = [];
    if (recData.relations) {
      for (const rel of recData.relations) {
        if (rel.type === 'performance' && rel.work && rel.work.id) {
          workIds.push(rel.work.id);
        }
      }
    }

    // Fetch each work for writer credits
    for (const workId of workIds.slice(0, 2)) {
      await sleep(1100);
      const workUrl = `https://musicbrainz.org/ws/2/work/${workId}?inc=artist-rels&fmt=json`;
      const r3 = await fetch(workUrl);
      if (!r3.ok) continue;
      const workData = await r3.json();

      if (workData.relations) {
        for (const rel of workData.relations) {
          if (!rel.artist) continue;
          const name = rel.artist.name;
          const t = (rel.type || '').toLowerCase();
          if (t === 'writer' || t === 'composer' || t === 'lyricist' || t === 'songwriter') {
            writers.push(name);
          }
        }
      }
    }

    writers = [...new Set(writers)];
    producers = [...new Set(producers)];
    arrangers = [...new Set(arrangers)];

    const credits = { writers, producers, arrangers };
    creditsCache[key] = credits;

    if (writers.length === 0 && producers.length === 0 && arrangers.length === 0) {
      el.innerHTML = '';
      return;
    }
    renderCredits(el, credits);

  } catch(e) {
    el.innerHTML = '';
  }
}

function renderCredits(el, credits) {
  const { writers, producers, arrangers } = credits;
  if (writers.length === 0 && producers.length === 0 && arrangers.length === 0) {
    el.innerHTML = '';
    return;
  }

  let h = `<div class="credits-section"><div class="credits-title">Credits</div>`;
  if (writers.length > 0) {
    h += `<div class="credits-row"><div class="credits-label">Written by</div><div class="credits-names">${writers.map(n => `<span>${n}</span>`).join(', ')}</div></div>`;
  }
  if (producers.length > 0) {
    h += `<div class="credits-row"><div class="credits-label">Produced by</div><div class="credits-names">${producers.map(n => `<span>${n}</span>`).join(', ')}</div></div>`;
  }
  if (arrangers.length > 0) {
    h += `<div class="credits-row"><div class="credits-label">Arranged by</div><div class="credits-names">${arrangers.map(n => `<span>${n}</span>`).join(', ')}</div></div>`;
  }
  h += `<div style="font-size:10px;color:#333;margin-top:8px">via MusicBrainz</div></div>`;
  el.innerHTML = h;
}

async function fetchArtistImage(name, elementId) {
  const key = 'artist:' + name;
  if (imgCache[key]) { applyImage(elementId, imgCache[key]); return; }
  try {
    const r = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(name)}&entity=musicArtist&limit=1`);
    const data = await r.json();
    if (data.results && data.results.length > 0) {
      // Get the largest available artist image
      let url = data.results[0].artworkUrl100 || '';
      // Try getting a bigger song image for the artist instead
      const r2 = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(name)}&entity=song&limit=1`);
      const d2 = await r2.json();
      if (d2.results && d2.results.length > 0) {
        url = (d2.results[0].artworkUrl100 || '').replace('100x100', '600x600');
      }
      if (url) { imgCache[key] = url; applyImage(elementId, url); }
    }
  } catch(e) { /* silently fail ‚Äî images are optional */ }
}

async function fetchSongImage(title, artist, elementId) {
  const key = 'song:' + title + '|' + artist;
  if (imgCache[key]) { applyImage(elementId, imgCache[key]); return; }
  try {
    const r = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(artist + ' ' + title)}&entity=song&limit=5`);
    const data = await r.json();
    if (data.results && data.results.length > 0) {
      // Try to find exact match first
      const exact = data.results.find(r => 
        r.trackName && r.artistName &&
        r.trackName.toLowerCase().includes(title.toLowerCase().substring(0, 10)) &&
        r.artistName.toLowerCase().includes(artist.toLowerCase().substring(0, 6))
      ) || data.results[0];
      const url = (exact.artworkUrl100 || '').replace('100x100', '600x600');
      if (url) { imgCache[key] = url; applyImage(elementId, url); }
    }
  } catch(e) {}
}

function applyImage(elementId, url) {
  const el = document.getElementById(elementId);
  if (!el) return;
  const img = new Image();
  img.onload = () => { el.innerHTML = `<img src="${url}" alt="">`; el.classList.add('loaded'); };
  img.onerror = () => {}; // silently fail
  img.src = url;
}

// ‚îÄ‚îÄ‚îÄ NARRATIVES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function songNarrative(title, artist, weeks, peakPos, maxWks, isAlbum) {
  if (!weeks || weeks.length < 2) return '';
  const first = weeks[0], last = weeks[weeks.length - 1];
  const debut = first.rank;
  const debutDate = fmtDate(first.date);
  const chartName = isAlbum ? 'Billboard 200' : 'Hot 100';

  // Weeks to peak
  const peakIdx = weeks.findIndex(w => w.rank === peakPos);
  const weeksToPeak = peakIdx >= 0 ? peakIdx + 1 : '?';

  // Weeks at peak
  const weeksAtPeak = weeks.filter(w => w.rank === peakPos).length;

  // Biggest single-week jump
  let biggestJump = 0, jumpWeek = null;
  for (let i = 1; i < weeks.length; i++) {
    const diff = (weeks[i-1].rank || 0) - (weeks[i].rank || 0);
    if (diff > biggestJump) { biggestJump = diff; jumpWeek = i; }
  }

  // Build narrative
  let n = `<strong>"${title}"</strong> by <span class="gld">${artist}</span> `;

  // Debut
  if (debut <= 10) n += `exploded onto the ${chartName} at <strong>#${debut}</strong> on ${debutDate}`;
  else if (debut <= 40) n += `entered the ${chartName} at a strong <strong>#${debut}</strong> on ${debutDate}`;
  else n += `debuted on the ${chartName} at <strong>#${debut}</strong> on ${debutDate}`;

  // Rise to peak
  if (peakPos === 1) {
    if (weeksToPeak === 1) n += ` and debuted at the summit`;
    else if (weeksToPeak <= 4) n += `, rocketing to <span class="gld">#1</span> in just ${weeksToPeak} weeks`;
    else if (weeksToPeak <= 8) n += `, climbing to <span class="gld">#1</span> in ${weeksToPeak} weeks`;
    else n += `, taking a steady ${weeksToPeak}-week climb to <span class="gld">#1</span>`;

    if (weeksAtPeak > 1) n += `, where it held the top spot for <strong>${weeksAtPeak} weeks</strong>`;
    else n += ` for a single week`;
  } else if (peakPos <= 10) {
    if (weeksToPeak <= 4) n += `, quickly rising to a peak of <strong>#${peakPos}</strong>`;
    else n += `, reaching a peak of <strong>#${peakPos}</strong> in week ${weeksToPeak}`;
    if (weeksAtPeak > 1) n += ` (${weeksAtPeak} weeks at peak)`;
  } else if (peakPos <= 40) {
    n += ` and peaked at <strong>#${peakPos}</strong>`;
  } else {
    n += ` and reached <strong>#${peakPos}</strong>`;
  }

  n += '. ';

  // Total run
  const wks = maxWks || weeks.length;
  if (wks >= 30) n += `With an impressive <strong>${wks}-week run</strong> on the chart, ${isAlbum ? 'the album' : 'it'} proved to have remarkable staying power.`;
  else if (wks >= 20) n += `${isAlbum ? 'The album' : 'The song'} spent a solid <strong>${wks} weeks</strong> on the chart.`;
  else if (wks >= 10) n += `It charted for <strong>${wks} weeks</strong>.`;
  else n += `It spent ${wks} weeks on the chart.`;

  // Biggest jump
  if (biggestJump >= 20 && jumpWeek) {
    n += ` Its biggest leap was a ${biggestJump}-position jump in week ${jumpWeek + 1}.`;
  }

  return `<div class="narrative"><p>${n}</p></div>`;
}

function artistNarrative(name, hl, n1, t10, totalWks, minY, maxY, isAlbum) {
  if (!hl || hl.length === 0) return '';
  const span = maxY - minY;
  const chartName = isAlbum ? 'Billboard 200' : 'Hot 100';
  const itemWord = isAlbum ? 'albums' : 'songs';
  const singleItem = isAlbum ? 'album' : 'chart entry';

  let n = `<span class="gld">${name}</span> `;

  if (span === 0) {
    n += `appeared on the ${chartName} in <strong>${minY}</strong>`;
  } else if (span <= 3) {
    n += `had a concentrated chart presence from <strong>${minY} to ${maxY}</strong>`;
  } else {
    n += `charted on the ${chartName} across <strong>${span} years</strong> (${minY}‚Äì${maxY})`;
  }

  if (hl.length === 1) {
    n += ` with a single ${singleItem}`;
  } else {
    n += `, placing <strong>${hl.length} ${itemWord}</strong> on the chart`;
  }

  if (n1 > 0) {
    const no1items = hl.filter(h => h.peak === 1);
    if (n1 === 1) {
      n += `, including the #1 ${isAlbum ? 'album' : 'hit'} <strong>"${no1items[0].title}"</strong>`;
    } else if (n1 === 2) {
      n += `, with two chart-toppers: <strong>"${no1items[0].title}"</strong> and <strong>"${no1items[1].title}"</strong>`;
    } else {
      n += `, with an impressive <strong>${n1} #1 ${isAlbum ? 'albums' : 'hits'}</strong>`;
    }
  }
  n += '. ';

  if (t10 > n1 && t10 >= 3) {
    n += `${t10} of their ${itemWord} reached the top 10. `;
  }

  if (n1 === 0) {
    const best = hl.reduce((a, b) => a.peak <= b.peak ? a : b);
    n += `Their biggest ${isAlbum ? 'album' : 'hit'} was <strong>"${best.title}"</strong>, peaking at <strong>#${best.peak}</strong>. `;
  }

  if (totalWks >= 200) {
    n += `Across all entries, they accumulated a remarkable <strong>${totalWks} total weeks</strong> on the chart.`;
  } else if (totalWks >= 50) {
    n += `They spent a combined <strong>${totalWks} weeks</strong> on the chart.`;
  }

  if (hl.length >= 3 && span >= 5) {
    const first = hl[0], last = hl[hl.length - 1];
    n += ` Their chart journey began with <strong>"${first.title}"</strong> in ${first.firstDate ? first.firstDate.substring(0,4) : '?'} and their last entry in this period was <strong>"${last.title}"</strong> in ${last.firstDate ? last.firstDate.substring(0,4) : '?'}.`;
  }

  return `<div class="narrative"><p>${n}</p></div>`;
}

// ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function switchView(v) {
  const currentView = document.querySelector('.view.active');
  if (currentView && v !== 'song') {
    previousView = currentView.id.replace('view-', '');
  } else if (currentView && v === 'song') {
    previousView = currentView.id.replace('view-', '');
  }
  document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('view-' + v).classList.add('active');
  const navBtn = document.querySelector(`.nav-btn[data-view="${v}"]`);
  if (navBtn) navBtn.classList.add('active');
  if (v === 'search') setTimeout(() => document.getElementById('searchInput').focus(), 100);
  if (v === 'artist') setTimeout(() => document.getElementById('artistInput').focus(), 100);
}

function renderEntry(e, i, showDate) {
  const r = e.rank, cls = r === 1 ? 'gold' : r <= 3 ? 'silver' : r <= 10 ? 'top10' : 'normal';
  const lw = e.lastWeek;
  let mi = '‚òÖ', mc = 'var(--new)';
  if (lw) { if (lw > r) { mi = '‚ñ≤'; mc = 'var(--up)'; } else if (lw < r) { mi = '‚ñº'; mc = 'var(--down)'; } else { mi = '‚ñ†'; mc = 'var(--same)'; } }
  return `<div class="chart-entry" style="animation-delay:${Math.min(i,20)*20}ms">
    <div class="rank-badge ${cls}">${r || '‚Äî'}</div>
    <div class="entry-info">
      <div class="entry-title clickable" onclick="searchFor('${esc(e.title)}','${esc(e.artist)}')">${e.title || ''}</div>
      <div class="entry-meta"><span class="entry-artist" onclick="goToArtist('${esc(e.artist)}')">${e.artist || ''}</span></div>
    </div>
    <div class="entry-stats">
      ${lw ? `<div class="stat-col"><div class="stat-header">LW</div><div class="stat-val">${lw}</div></div>` : '<div class="stat-col"><div class="stat-header">LW</div><div class="stat-val">‚Äî</div></div>'}
      ${e.peak ? `<div class="stat-col"><div class="stat-header">PK</div><div class="stat-val">${e.peak}</div></div>` : ''}
      ${e.weeks ? `<div class="stat-col"><div class="stat-header">WK</div><div class="stat-val">${e.weeks}</div></div>` : ''}
      <div class="movement" style="color:${mc}">${mi}</div>
    </div>
    ${showDate && e.date ? `<div class="chart-badge">${e.date.substring(0,4)}</div>` : ''}</div>`;
}

function esc(s) { return (s || '').replace(/'/g, "\\'").replace(/"/g, '&quot;'); }
function fmtDate(s) { if (!s || s.length < 10) return s || ''; const d = new Date(s + 'T12:00:00'); return d.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }); }
function validWeekCount() {
  const cache = activeCache();
  return Object.keys(cache).filter(d => Array.isArray(cache[d]) && cache[d].length > 0).length;
}

function updateStats() {
  const cache = activeCache();
  const dates = activeDates();
  const w = validWeekCount();
  const t = Object.values(cache).reduce((s, e) => s + (Array.isArray(e) ? e.length : 0), 0);
  const label = chartType === 'hot100' ? 'Hot 100' : 'Billboard 200';
  const range = chartType === 'hot100' ? '1958‚Äì2019' : (filteredAlbumDates.length ? filteredAlbumDates[0].substring(0,4) + '‚Äì' + filteredAlbumDates[filteredAlbumDates.length-1].substring(0,4) : '');
  document.getElementById('footerStats').textContent = `${label}: ${w} weeks loaded ‚Ä¢ ${t.toLocaleString()} entries${dates.length ? ' ‚Ä¢ ' + dates.length + ' available (' + range + ')' : ''}`;
}

// ‚îÄ‚îÄ‚îÄ START ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
